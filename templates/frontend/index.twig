{% extends 'frontend/base.twig' %}

{% block title %}Bibliografía UCN - Carreras de Pregrado{% endblock %}

{% block content %}
<!-- Hero Section con Filtros -->
<section class="hero-section">
    <div class="hero-background"></div>
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-3 text-white">
                    <i class="fas fa-book-open me-3"></i>
                    Bibliografía UCN
                </h1>
                <p class="lead mb-4 text-white">
                    Consulta las bibliografías disponibles para las carreras de pregrado de la Universidad Católica del Norte.
                    Encuentra libros, artículos, tesis y otros recursos académicos organizados por programa.
                </p>
            </div>
            <div class="col-lg-4 text-center">
                <i class="fas fa-university text-white" style="font-size: 8rem; opacity: 0.8;"></i>
            </div>
        </div>
        
        <!-- Filtros de Sede -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="filter-section">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label text-white fw-bold">Sedes</label>
                            <select class="form-select sede-select" id="sedeSelect">
                                <option value="todas">Todas</option>
                                {% for sede in sedes %}
                                <option value="{{ sede.id }}" {% if sede_filtro == sede.id %}selected{% endif %}>{{ sede.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-white fw-bold">Carreras</label>
                            <input type="text" class="form-control" id="carreraSearch" placeholder="¿Qué carrera buscas?">
                        </div>
                        <div class="col-md-4 d-flex flex-column">
                            <label class="form-label text-white fw-bold">Acción</label>
                            <button class="btn btn-warning btn-lg w-100 mt-auto" id="buscarBtn">
                                <i class="fas fa-search me-2"></i>Buscar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Sección de Filtros por Áreas -->
<section class="container mb-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Explora las distintas áreas</h2>
            <div class="filter-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-sede="todas">
                        TODAS
                    </button>
                    {% for sede in sedes %}
                    <button class="tab-btn" data-sede="{{ sede.id }}">
                        {{ sede.nombre|upper }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Sección de Carreras -->
<section id="carreras" class="container">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-5">
                <i class="fas fa-graduation-cap me-2"></i>
                Carreras de Pregrado
            </h2>
        </div>
    </div>

    <div class="row" id="carrerasContainer">
        {% if carreras|length > 0 %}
            {% for carrera in carreras %}
            <div class="col-md-6 col-lg-4 mb-4 carrera-item" 
                 data-sedes="{{ carrera.sedes_ids|join(',') }}"
                 data-nombre="{{ carrera.nombre|lower }}">
                <div class="card h-100 carrera-card">
                    <div class="carrera-image">
                        {% if carrera.imagen_url %}
                            <img src="{{ app_url }}/biblioges/{{ carrera.imagen_url }}" alt="{{ carrera.nombre }}" class="card-img-top" style="object-fit:cover; width:100%; height:200px;">
                        {% else %}
                            <img src="{{ assets_url }}/images/carreras/default.svg" alt="Imagen no disponible" class="card-img-top" style="object-fit:cover; width:100%; height:200px;">
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ carrera.nombre }}</h5>
                        <p class="card-text">{{ carrera.descripcion|default('Forma profesionales capaces de optimizar procesos productivos y de servicios.') }}</p>
                        <div class="carrera-meta">
                            <div class="meta-item">
                                <i class="fas fa-clock"></i>
                                <span>{{ carrera.cantidad_semestres|default(10) }} semestres</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>{{ carrera.sedes_nombres|join(', ') }}</span>
                            </div>
                        </div>
                        {% if carrera.sede_id %}
                        <a href="{{ app_url }}/carrera/{{ carrera.sede_id }}/{{ carrera.id }}" 
                           class="btn btn-primary btn-ver-bibliografia"
                           data-carrera-id="{{ carrera.id }}"
                           data-sedes="{{ carrera.sedes_ids|join(',') }}">
                            <i class="fas fa-book me-1"></i>
                            Ver Bibliografía
                        </a>
                        {% else %}
                        <button class="btn btn-secondary btn-ver-bibliografia" disabled>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            No disponible
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay carreras de pregrado disponibles en este momento.
                </div>
            </div>
        {% endif %}
    </div>
</section>

<!-- Información Adicional -->
<section class="container mb-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Información del Sistema
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-book me-2 text-primary"></i>Tipos de Bibliografía</h5>
                            <ul class="list-unstyled">
                                <li><span class="badge badge-basica me-2">Básica</span> Bibliografía fundamental del curso</li>
                                <li><span class="badge badge-complementaria me-2">Complementaria</span> Bibliografía adicional recomendada</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-file-alt me-2 text-success"></i>Tipos de Material</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-book me-2"></i>Libros</li>
                                <li><i class="fas fa-newspaper me-2"></i>Artículos</li>
                                <li><i class="fas fa-file-pdf me-2"></i>Tesis</li>
                                <li><i class="fas fa-laptop me-2"></i>Software</li>
                                <li><i class="fas fa-globe me-2"></i>Sitios Web</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Función global para filtrar carreras
function filtrarCarreras() {
    console.log('=== EJECUTANDO FILTRO DE CARRERAS ===');
    
    const sedeSelect = document.getElementById('sedeSelect');
    const carreraSearch = document.getElementById('carreraSearch');
    const carreraItems = document.querySelectorAll('.carrera-item');
    
    if (!sedeSelect || !carreraSearch) {
        console.error('Elementos de filtro no encontrados');
        return;
    }
    
    const sedeSeleccionada = sedeSelect.value;
    const busqueda = carreraSearch.value.toLowerCase().trim();
    
    console.log('Sede seleccionada:', sedeSeleccionada);
    console.log('Búsqueda:', busqueda);
    console.log('Total carreras:', carreraItems.length);
    
    let carrerasMostradas = 0;
    
    carreraItems.forEach((item, index) => {
        const sedesCarrera = item.getAttribute('data-sedes') || '';
        const nombreCarrera = item.getAttribute('data-nombre') || '';
        
        let mostrar = true;
        
        // Filtro por sede
        if (sedeSeleccionada !== 'todas') {
            const sedesArray = sedesCarrera.split(',').map(s => s.trim());
            if (!sedesArray.includes(sedeSeleccionada)) {
                mostrar = false;
            }
        }
        
        // Filtro por búsqueda
        if (busqueda && !nombreCarrera.includes(busqueda)) {
            mostrar = false;
        }
        
        if (mostrar) {
            item.style.display = 'block';
            item.classList.add('fade-in');
            carrerasMostradas++;
        } else {
            item.style.display = 'none';
            item.classList.remove('fade-in');
        }
    });
    
    console.log('Carreras mostradas:', carrerasMostradas);
    console.log('=== FILTRO COMPLETADO ===');
}

// Sincroniza la pestaña activa con el valor del select de sedes
function setActiveTab(sedeId) {
    const tabs = document.querySelectorAll('.tab-btn');
    if (!tabs || tabs.length === 0) return;
    tabs.forEach(btn => btn.classList.remove('active'));
    let target = Array.from(tabs).find(btn => btn.getAttribute('data-sede') === sedeId);
    if (!target) {
        target = Array.from(tabs).find(btn => btn.getAttribute('data-sede') === 'todas');
    }
    if (target) target.classList.add('active');
}

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== INICIANDO FILTROS DE CARRERAS ===');
    
    // Verificar elementos
    const sedeSelect = document.getElementById('sedeSelect');
    const carreraSearch = document.getElementById('carreraSearch');
    const buscarBtn = document.getElementById('buscarBtn');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const carreraItems = document.querySelectorAll('.carrera-item');
    
    console.log('Elementos encontrados:');
    console.log('- sedeSelect:', sedeSelect ? 'OK' : 'NO ENCONTRADO');
    console.log('- carreraSearch:', carreraSearch ? 'OK' : 'NO ENCONTRADO');
    console.log('- buscarBtn:', buscarBtn ? 'OK' : 'NO ENCONTRADO');
    console.log('- tabButtons:', tabButtons.length);
    console.log('- carreraItems:', carreraItems.length);
    
    // Event listeners
    if (sedeSelect) {
        sedeSelect.addEventListener('change', function() {
            console.log('Cambio en sede select:', this.value);
            // Sincronizar pestañas
            setActiveTab(this.value);
            filtrarCarreras();
        });
    }
    
    if (carreraSearch) {
        carreraSearch.addEventListener('input', function() {
            console.log('Búsqueda:', this.value);
            filtrarCarreras();
        });
    }
    
    if (buscarBtn) {
        buscarBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Botón buscar clickeado');
            filtrarCarreras();
        });
    }
    
    // Tabs de sedes
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            console.log('Tab clickeado:', this.textContent.trim());
            
            // Remover clase active de todos los botones
            tabButtons.forEach(btn => btn.classList.remove('active'));
            // Agregar clase active al botón clickeado
            this.classList.add('active');
            
            // Filtrar por sede
            const sedeId = this.getAttribute('data-sede');
            if (sedeSelect) {
                sedeSelect.value = sedeId;
            }
            filtrarCarreras();
        });
    });
    
    // Aplicar filtro inicial
    console.log('Aplicando filtro inicial...');
    // Sincronizar pestañas con el valor inicial del select
    if (sedeSelect) {
        setActiveTab(sedeSelect.value);
    }
    filtrarCarreras();
    
    console.log('=== FILTROS INICIALIZADOS ===');
    
    // Manejar clics en botones de "Ver Bibliografía"
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-ver-bibliografia')) {
            e.preventDefault();
            
            const button = e.target.closest('.btn-ver-bibliografia');
            const carreraId = button.getAttribute('data-carrera-id');
            const sedesDisponibles = button.getAttribute('data-sedes').split(',');
            const sedeSeleccionada = sedeSelect.value;
            
            console.log('Carrera ID:', carreraId);
            console.log('Sedes disponibles:', sedesDisponibles);
            console.log('Sede seleccionada:', sedeSeleccionada);
            
            // Verificar si la sede seleccionada está disponible para esta carrera
            if (sedeSeleccionada === 'todas' || sedesDisponibles.includes(sedeSeleccionada)) {
                // Usar la sede seleccionada o la primera disponible
                const sedeParaUsar = sedeSeleccionada === 'todas' ? sedesDisponibles[0] : sedeSeleccionada;
                const url = `${window.location.origin}/carrera/${sedeParaUsar}/${carreraId}`;
                console.log('Navegando a:', url);
                window.location.href = url;
            } else {
                // Si la sede seleccionada no está disponible, usar la primera sede disponible
                const sedeParaUsar = sedesDisponibles[0];
                const url = `${window.location.origin}/carrera/${sedeParaUsar}/${carreraId}`;
                console.log('Sede seleccionada no disponible, usando:', sedeParaUsar);
                console.log('Navegando a:', url);
                window.location.href = url;
            }
        }
    });
});

// Función global para debug
window.debugFiltros = function() {
    console.log('=== DEBUG FILTROS ===');
    console.log('sedeSelect value:', document.getElementById('sedeSelect')?.value);
    console.log('carreraSearch value:', document.getElementById('carreraSearch')?.value);
    console.log('carreraItems:', document.querySelectorAll('.carrera-item').length);
    console.log('tabButtons:', document.querySelectorAll('.tab-btn').length);
    filtrarCarreras();
};
</script>
{% endblock %} 