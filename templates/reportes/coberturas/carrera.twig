{% extends "base.twig" %}

{% block title %}Coberturas Básicas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Coberturas Básicas</h3>
                    <h5 class="card-subtitle">{{ carrera.sede }} - {{ carrera.codigo }} - {{ carrera.nombre }}</h5>
                </div>
                <div class="card-body">
                    <!-- Botones de acción -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </button>
                                <a href="/biblioges/reportes/coberturas-expandido/{{ carrera.sede_id }}/{{ carrera.carrera_id }}?{{ app.request.queryString }}" 
                                   class="btn btn-success">
                                    <i class="fas fa-expand-alt"></i> Reporte Expandido
                                </a>
                                <a href="/biblioges/reportes/coberturas-fusionado/{{ carrera.sede_id }}/{{ carrera.carrera_id }}?{{ app.request.queryString }}" 
                                   class="btn btn-info">
                                    <i class="fas fa-object-group"></i> Fusión de Reportes
                                </a>
                                <button type="button" class="btn btn-excel" id="btnExportarExcel">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="exportarCSV()">
                                    <i class="fas fa-file-csv"></i> Exportar CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <a id="enlaceDescargaExcel" href="#" class="btn btn-success d-none" download target="_blank">Descargar Excel generado</a>

                    <form id="filtroFormacionForm" method="get">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <h6>Selección de Asignaturas de Formación</h6>
                                <p class="text-muted small mb-2">
                                    Tipos de formación disponibles para esta carrera: 
                                    {% for tipo in tipos_formacion_disponibles %}
                                        <span class="badge bg-info">{{ tipo }}</span>
                                    {% endfor %}
                                </p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_basica" name="tipos_formacion[]" value="FORMACION_BASICA" 
                                                   {% if not hay_filtros_aplicados or 'FORMACION_BASICA' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_basica">
                                                Formación Básica 
                                                <small class="text-muted">({{ 'FORMACION_BASICA' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_general" name="tipos_formacion[]" value="FORMACION_GENERAL"
                                                   {% if not hay_filtros_aplicados or 'FORMACION_GENERAL' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_general">
                                                Formación General
                                                <small class="text-muted">({{ 'FORMACION_GENERAL' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_idiomas" name="tipos_formacion[]" value="FORMACION_IDIOMAS"
                                                   {% if not hay_filtros_aplicados or 'FORMACION_IDIOMAS' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_idiomas">
                                                Formación Idiomas
                                                <small class="text-muted">({{ 'FORMACION_IDIOMAS' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_profesional" name="tipos_formacion[]" value="FORMACION_PROFESIONAL"
                                                   {% if not hay_filtros_aplicados or 'FORMACION_PROFESIONAL' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_profesional">
                                                Formación Profesional
                                                <small class="text-muted">({{ 'FORMACION_PROFESIONAL' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_valores" name="tipos_formacion[]" value="FORMACION_VALORES"
                                                   {% if not hay_filtros_aplicados or 'FORMACION_VALORES' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_valores">
                                                Formación Valores
                                                <small class="text-muted">({{ 'FORMACION_VALORES' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_especialidad" name="tipos_formacion[]" value="FORMACION_ESPECIALIDAD"
                                                   {% if not hay_filtros_aplicados or 'FORMACION_ESPECIALIDAD' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_especialidad">
                                                Formación Especialidad
                                                <small class="text-muted">({{ 'FORMACION_ESPECIALIDAD' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_especial" name="tipos_formacion[]" value="FORMACION_ESPECIAL"
                                                   {% if not hay_filtros_aplicados or 'FORMACION_ESPECIAL' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_especial">
                                                Formación Especial
                                                <small class="text-muted">({{ 'FORMACION_ESPECIAL' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm mt-2">
                                            <i class="fas fa-filter"></i> Aplicar Filtros
                                        </button>
                                <button type="button" class="btn btn-success btn-sm mt-2" onclick="guardarFiltros()">
                                    <i class="fas fa-save"></i> Guardar Filtros
                                </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div class="table-responsive">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>Bibliografía Básica de la Carrera</h6>
                            <span class="badge bg-secondary" id="contador-asignaturas">
                                Mostrando {{ asignaturas|length }} asignaturas
                            </span>
                        </div>
                        <table class="table table-striped table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Código Asignatura</th>
                                    <th>Nombre</th>
                                    <th>Tipo Asignatura</th>
                                    <th>Estado</th>
                                    <th class="text-center"># Títulos Declarados</th>
                                    <th class="text-center"># Títulos Disponibles</th>
                                    <th class="text-center"># Ejemplares Impresos</th>
                                    <th class="text-center"># Ejemplares Digitales</th>
                                    <th class="text-center">Cobertura Básica</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for asignatura in asignaturas %}
                                <tr>
                                    <td><strong>{{ asignatura.codigo }}</strong></td>
                                    <td>{{ asignatura.nombre }}</td>
                                    <td>
                                        {% if asignatura.tipo_asignatura == 'REGULAR' %}
                                            <span class="badge bg-success">REGULAR</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_BASICA' %}
                                            <span class="badge bg-primary">Formación Básica</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_GENERAL' %}
                                            <span class="badge bg-info">Formación General</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_IDIOMAS' %}
                                            <span class="badge bg-warning">Formación Idiomas</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_PROFESIONAL' %}
                                            <span class="badge bg-secondary">Formación Profesional</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_VALORES' %}
                                            <span class="badge bg-dark">Formación Valores</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_ESPECIALIDAD' %}
                                            <span class="badge bg-danger">Formación Especialidad</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_ESPECIAL' %}
                                            <span class="badge bg-purple">Formación Especial</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ asignatura.tipo_asignatura }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if asignatura.estado == 1 or asignatura.estado == 'Activa' %}
                                            <span class="badge bg-success">Activa</span>
                                        {% else %}
                                            <span class="badge bg-danger">No Activa</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ asignatura.titulos_declarados }}</td>
                                    <td class="text-center">{{ asignatura.titulos_disponibles }}</td>
                                    <td class="text-center">
                                        {% if asignatura.titulos_declarados == 0 or (asignatura.ejemplares_impresos == 0 and asignatura.ejemplares_digitales == 0 and asignatura.titulos_disponibles == 0) %}
                                            <span class="text-muted">Sin información</span>
                                        {% else %}
                                            {{ asignatura.ejemplares_impresos }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if asignatura.titulos_declarados == 0 or (asignatura.ejemplares_impresos == 0 and asignatura.ejemplares_digitales == 0 and asignatura.titulos_disponibles == 0) %}
                                            <span class="text-muted">Sin información</span>
                                        {% elseif asignatura.titulos_disponibles > 0 and asignatura.ejemplares_digitales == 0 %}
                                            <span class="text-success">Ilimitado</span>
                                        {% else %}
                                            {{ asignatura.ejemplares_digitales }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if asignatura.cobertura_basica == 100 %}
                                            <span class="badge bg-success">{{ asignatura.cobertura_basica }}%</span>
                                        {% elseif asignatura.cobertura_basica > 0 %}
                                            <span class="badge bg-warning">{{ asignatura.cobertura_basica }}%</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ asignatura.cobertura_basica }}%</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="/biblioges/reportes/coberturas/{{ carrera.sede_id }}/{{ carrera.carrera_id }}/{{ asignatura.codigo }}" class="btn btn-sm btn-outline-primary" title="Ver títulos declarados">
                                            <i class="fas fa-book"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Fila de totales -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-calculator"></i> Totales de la Carrera
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-primary">{{ totales_carrera.titulos_declarados }}</h4>
                                <p class="text-muted mb-0">Total Títulos Declarados</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-info">{{ totales_carrera.titulos_disponibles }}</h4>
                                <p class="text-muted mb-0">Total Títulos Disponibles</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-success">{{ totales_carrera.ejemplares_impresos }}</h4>
                                <p class="text-muted mb-0">Total Ejemplares Impresos</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-info">
                                    {% if totales_carrera.titulos_disponibles > 0 and totales_carrera.ejemplares_digitales == 0 %}
                                        Ilimitado
                                    {% elseif totales_carrera.ejemplares_digitales == 0 %}
                                        Sin información
                                    {% else %}
                                        {{ totales_carrera.ejemplares_digitales }}
                                    {% endif %}
                                </h4>
                                <p class="text-muted mb-0">Total Ejemplares Digitales</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="{% if cobertura_basica_total >= 80 %}text-success{% elseif cobertura_basica_total >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ cobertura_basica_total }}%
                                </h4>
                                <p class="text-muted mb-0">Cobertura Básica de la Carrera</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.btn-excel {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.btn-excel:hover {
    background-color: #218838;
    border-color: #1e7e34;
    color: white;
}

.btn-excel:focus {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
$(document).ready(function() {
    // Verificar si el usuario desmarcó todos los checkboxes
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('tipos_formacion_vacio')) {
        // Desmarcar todos los checkboxes de formación
        $('.form-check-input[name="tipos_formacion[]"]').prop('checked', false);
    }

    // Mapeo de IDs de checkbox a tipos de asignatura
    var tipoMapping = {
        'formacion_basica': 'FORMACION_BASICA',
        'formacion_general': 'FORMACION_GENERAL',
        'formacion_idiomas': 'FORMACION_IDIOMAS',
        'formacion_profesional': 'FORMACION_PROFESIONAL',
        'formacion_valores': 'FORMACION_VALORES',
        'formacion_especialidad': 'FORMACION_ESPECIALIDAD',
        'formacion_especial': 'FORMACION_ESPECIAL'
    };

    // Función para actualizar la visibilidad de las filas
    function updateTableVisibility() {
        var visibleTypes = [];
        Object.keys(tipoMapping).forEach(function(checkboxId) {
            if ($('#' + checkboxId).is(':checked')) {
                visibleTypes.push(tipoMapping[checkboxId]);
            }
        });
        var visibleRows = 0;
        $('tbody tr').each(function() {
            if ($(this).attr('id') === 'fila-totales') {
                $(this).show();
                return;
            }
            var tipoAsignaturaElement = $(this).find('td:eq(2) .badge');
            var tipoAsignatura = '';
            if (tipoAsignaturaElement.length > 0) {
                var badgeText = tipoAsignaturaElement.text().trim();
                if (badgeText === 'REGULAR') {
                    tipoAsignatura = 'REGULAR';
                } else if (badgeText === 'Formación Básica') {
                    tipoAsignatura = 'FORMACION_BASICA';
                } else if (badgeText === 'Formación General') {
                    tipoAsignatura = 'FORMACION_GENERAL';
                } else if (badgeText === 'Formación Idiomas') {
                    tipoAsignatura = 'FORMACION_IDIOMAS';
                } else if (badgeText === 'Formación Profesional') {
                    tipoAsignatura = 'FORMACION_PROFESIONAL';
                } else if (badgeText === 'Formación Valores') {
                    tipoAsignatura = 'FORMACION_VALORES';
                } else if (badgeText === 'Formación Especialidad') {
                    tipoAsignatura = 'FORMACION_ESPECIALIDAD';
                } else if (badgeText === 'Formación Especial') {
                    tipoAsignatura = 'FORMACION_ESPECIAL';
                } else {
                    tipoAsignatura = badgeText;
                }
            }
            var isRegular = tipoAsignatura === 'REGULAR';
            var isVisible = isRegular || visibleTypes.includes(tipoAsignatura);
            $(this).toggle(isVisible);
            if (isVisible) {
                visibleRows++;
            }
        });
        $('#contador-asignaturas').text('Mostrando ' + visibleRows + ' asignaturas');
        var totalCheckboxes = Object.keys(tipoMapping).length;
        var checkedCheckboxes = visibleTypes.length;
        $('#select_all').prop('checked', checkedCheckboxes === totalCheckboxes);
        $('#select_all').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
    }

    // Eliminar actualización automática al cambiar los checkboxes
    // $('.form-check-input').not('#select_all').change(function() {
    //     updateTableVisibility();
    // });

    // Evento para 'Seleccionar Todo' (solo marca/desmarca, no actualiza tabla)
    $('#select_all').change(function() {
        var isChecked = $(this).is(':checked');
        Object.keys(tipoMapping).forEach(function(checkboxId) {
            $('#' + checkboxId).prop('checked', isChecked);
        });
        // No llamar a updateTableVisibility();
    });

    // Evento para el formulario de filtros
    $('#filtroFormacionForm').submit(function(e) {
        e.preventDefault();

        // Verificar si hay algún checkbox de formación seleccionado
        var algunoSeleccionado = false;
        $('.form-check-input[name="tipos_formacion[]"]:checked').each(function() {
            algunoSeleccionado = true;
        });

        // Si ninguno está seleccionado, agregar un campo oculto
        if (!algunoSeleccionado) {
            if ($('#ningun_tipo_formacion').length === 0) {
                $(this).append('<input type="hidden" id="ningun_tipo_formacion" name="tipos_formacion_vacio" value="1">');
            }
        } else {
            $('#ningun_tipo_formacion').remove();
        }

        var formData = $(this).serialize();
        var currentUrl = window.location.pathname;
        var newUrl = currentUrl + '?' + formData;
        window.location.href = newUrl;
    });

    // Inicializar la visibilidad solo al cargar la página
    updateTableVisibility();
});

// Función para exportar a Excel
function exportarExcel() {
    var data = [];
    var headers = ['Código Asignatura', 'Nombre', 'Tipo Asignatura', 'Estado', 'Títulos Declarados', 'Títulos Disponibles', 'Ejemplares Impresos', 'Ejemplares Digitales', 'Cobertura Básica'];
    data.push(headers);

    // Filas de datos
    $('tbody tr:visible').each(function() {
        if ($(this).attr('id') === 'fila-totales') return;
        var row = [];
        row.push($(this).find('td:eq(0)').text().trim()); // Código
        row.push($(this).find('td:eq(1)').text().trim()); // Nombre
        row.push($(this).find('td:eq(2) .badge').text().trim()); // Tipo Asignatura
        row.push($(this).find('td:eq(3) .badge').text().trim()); // Estado
        row.push($(this).find('td:eq(4)').text().trim()); // Títulos Declarados
        row.push($(this).find('td:eq(5)').text().trim()); // Títulos Disponibles
        row.push($(this).find('td:eq(6)').text().trim()); // Ejemplares Impresos
        row.push($(this).find('td:eq(7)').text().trim()); // Ejemplares Digitales
        // Cobertura: extraer el texto del badge o el valor plano
        var coberturaText = $(this).find('td:eq(8) .badge').text().trim();
        if (!coberturaText) coberturaText = $(this).find('td:eq(8)').text().trim();
        row.push(coberturaText);
        data.push(row);
    });

    // Totales de la carrera (usar valores de Twig)
    var totalesRow = [
        'TOTALES DE LA CARRERA', // A
        '',                     // B
        '',                     // C
        '',                     // D
        '{{ totales_carrera.titulos_declarados }}', // E
        '{{ totales_carrera.titulos_disponibles }}', // F
        '{{ totales_carrera.ejemplares_impresos }}', // G
        '{{ totales_carrera.ejemplares_digitales }}', // H
        '{{ cobertura_basica_total }}%'              // I
    ];
    data.push(totalesRow);

    // Crear workbook y worksheet
    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [
        { wch: 15 }, { wch: 40 }, { wch: 20 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 18 }, { wch: 18 }, { wch: 15 }
    ];

    // Aplicar estilos a los encabezados y totales
    if (!ws['!cols']) ws['!cols'] = [];
    var headerStyle = {
        fill: { fgColor: { rgb: "4472C4" } },
        font: { color: { rgb: "FFFFFF" }, bold: true },
        alignment: { horizontal: "center" },
        border: {
            top: {style: "thin", color: {rgb: "000000"}},
            bottom: {style: "thin", color: {rgb: "000000"}},
            left: {style: "thin", color: {rgb: "000000"}},
            right: {style: "thin", color: {rgb: "000000"}}
        }
    };
    var totalStyle = {
        fill: { fgColor: { rgb: "F2F2F2" } },
        font: { bold: true },
        alignment: { horizontal: "center" },
        border: {
            top: {style: "thin", color: {rgb: "000000"}},
            bottom: {style: "thin", color: {rgb: "000000"}},
            left: {style: "thin", color: {rgb: "000000"}},
            right: {style: "thin", color: {rgb: "000000"}}
        }
    };
    var range = XLSX.utils.decode_range(ws['!ref']);
    for (var col = range.s.c; col <= range.e.c; col++) {
        var headerCell = XLSX.utils.encode_cell({ r: 0, c: col });
        var totalCell = XLSX.utils.encode_cell({ r: data.length - 1, c: col });
        if (ws[headerCell]) ws[headerCell].s = headerStyle;
        if (ws[totalCell]) ws[totalCell].s = totalStyle;
    }

    XLSX.utils.book_append_sheet(wb, ws, "Bibliografía Básica");
    var fileName = 'Reporte_Bibliografia_Basica_{{ carrera.sede }}_{{ carrera.codigo }}_{{ carrera.nombre|replace({' ': '_'}) }}.xlsx';
    XLSX.writeFile(wb, fileName);
}

// Función para exportar a CSV (mantener la existente)
function exportarCSV() {
    // Crear una tabla temporal para la exportación
    var table = document.createElement('table');
    
    // Agregar encabezados
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    var headers = ['Código Asignatura', 'Nombre', 'Tipo Asignatura', 'Estado', 'Títulos Declarados', 'Títulos Disponibles', 'Ejemplares Impresos', 'Ejemplares Digitales', 'Cobertura Básica'];
    
    headers.forEach(function(header) {
        var th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Agregar datos
    var tbody = document.createElement('tbody');
    
    // Agregar filas visibles
    $('tbody tr:visible').each(function() {
        if ($(this).attr('id') === 'fila-totales') {
            return; // Saltar la fila de totales
        }
        
        var tr = document.createElement('tr');
        
        // Código
        var td1 = document.createElement('td');
        td1.textContent = $(this).find('td:eq(0)').text().trim();
        tr.appendChild(td1);
        
        // Nombre
        var td2 = document.createElement('td');
        td2.textContent = $(this).find('td:eq(1)').text().trim();
        tr.appendChild(td2);
        
        // Tipo Asignatura
        var td3 = document.createElement('td');
        td3.textContent = $(this).find('td:eq(2) .badge').text().trim();
        tr.appendChild(td3);
        
        // Estado
        var td4 = document.createElement('td');
        td4.textContent = $(this).find('td:eq(3) .badge').text().trim();
        tr.appendChild(td4);
        
        // Títulos Declarados
        var td5 = document.createElement('td');
        td5.textContent = $(this).find('td:eq(4)').text().trim();
        tr.appendChild(td5);
        
        // Títulos Disponibles
        var td6 = document.createElement('td');
        td6.textContent = $(this).find('td:eq(5)').text().trim();
        tr.appendChild(td6);
        
        // Ejemplares Impresos
        var td7 = document.createElement('td');
        td7.textContent = $(this).find('td:eq(6)').text().trim();
        tr.appendChild(td7);
        
        // Ejemplares Digitales
        var td8 = document.createElement('td');
        td8.textContent = $(this).find('td:eq(7)').text().trim();
        tr.appendChild(td8);
        
        // Cobertura Básica
        var td9 = document.createElement('td');
        td9.textContent = $(this).find('td:eq(8) .badge').text().trim();
        tr.appendChild(td9);
        
        tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    
    // Convertir tabla a CSV
    var csvContent = '\uFEFF'; // BOM para UTF-8
    var rows = table.querySelectorAll('tr');
    
    for (var i = 0; i < rows.length; i++) {
        var row = [], cols = rows[i].querySelectorAll('td, th');
        
        for (var j = 0; j < cols.length; j++) {
            // Escapar comillas dobles y envolver en comillas
            var text = cols[j].textContent.replace(/"/g, '""');
            row.push('"' + text + '"');
        }
        
        csvContent += row.join(',') + '\n';
    }
    
    // Crear y descargar el archivo
    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    
    if (link.download !== undefined) {
        var url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'Reporte_Bibliografia_Basica_{{ carrera.sede }}_{{ carrera.codigo }}_{{ carrera.nombre|replace({' ': '_'}) }}.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

$('#btnExportarExcel').click(function() {
    var url = '/biblioges/reportes/coberturas-excel/{{ carrera.sede_id }}/{{ carrera.carrera_id }}';
    var btn = $(this);
    btn.prop('disabled', true).text('Generando...');
    $.get(url, function(data) {
        if (data.url) {
            $('#enlaceDescargaExcel').removeClass('d-none').attr('href', data.url).text('Descargar Excel generado');
            window.open(data.url, '_blank');
        } else {
            console.error('No se pudo generar el archivo.');
        }
    }).always(function() {
        btn.prop('disabled', false).html('<i class="fas fa-file-excel"></i> Exportar Excel');
    });
});

// Función para guardar filtros de formación
function guardarFiltros() {
    var filtros = [];
    $('.form-check-input[name="tipos_formacion[]"]:checked').each(function() {
        filtros.push($(this).val());
    });
    
    var btn = $('button[onclick="guardarFiltros()"]');
    var originalText = btn.html();
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
    
    $.ajax({
        url: '/biblioges/reportes/guardar-filtros-formacion/{{ carrera.sede_id }}/{{ carrera.carrera_id }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ filtros: filtros }),
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    title: '¡Éxito!',
                    text: response.message,
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: response.error || 'Error al guardar los filtros',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error al guardar los filtros: ' + error,
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        }
    }).always(function() {
        btn.prop('disabled', false).html(originalText);
    });
}
</script>
{% endblock %} 