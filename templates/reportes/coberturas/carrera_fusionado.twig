{% extends "base.twig" %}

{% block title %}Reporte Fusionado de Coberturas{% endblock %}

{% block current_page %}coberturas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Reporte Fusionado de Coberturas</h3>
                    <h5 class="card-subtitle">{{ carrera.sede }} - {{ carrera.codigo }} - {{ carrera.nombre }}</h5>
                    <p class="card-text text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Este reporte combina las coberturas básicas y complementarias de la carrera.
                    </p>
                </div>
                <div class="card-body">
                    <!-- Botones de acción -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </button>
                                <button type="button" class="btn btn-success d-none" style="display:none">
                                    <i class="fas fa-save"></i> Guardar Reporte
                                </button>
                                <button type="button" class="btn btn-excel" onclick="exportarExcel()">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    {% if sin_datos %}
                        <!-- Alerta cuando no hay datos -->
                        <div class="alert alert-warning" role="alert">
                            <h4 class="alert-heading">
                                <i class="fas fa-exclamation-triangle"></i> No hay reportes generados
                            </h4>
                            <p>
                                No se encontraron reportes de cobertura básica o complementaria generados para esta carrera en el año actual.
                            </p>
                            <hr>
                            <p class="mb-0">
                                Para generar el reporte fusionado, primero debe:
                                <ul class="mb-0 mt-2">
                                    <li>Generar el reporte de <strong>Coberturas Básicas Expandido</strong> y guardarlo</li>
                                    <li>Generar el reporte de <strong>Coberturas Complementarias Expandido</strong> y guardarlo</li>
                                </ul>
                            </p>
                        </div>
                    {% else %}
                        <!-- Resumen de coberturas -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Cobertura Básica</h5>
                                        <h2 class="text-primary">{{ cobertura_basica|default('0') }}%</h2>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                Títulos Disponibles: {{ totales_basica.titulos_disponibles|default('0') }} / 
                                                Títulos Declarados: {{ totales_basica.titulos_declarados|default('0') }}
                                            </small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Cobertura Complementaria</h5>
                                        <h2 class="text-success">{{ cobertura_complementaria|default('0') }}%</h2>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                Títulos Disponibles: {{ totales_complementaria.titulos_disponibles|default('0') }} / 
                                                Títulos Declarados: {{ totales_complementaria.titulos_declarados|default('0') }}
                                            </small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {% if not sin_datos %}
                        <div class="table-responsive mt-4">
                            <table class="table table-bordered align-middle" id="tablaFusionada">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="align-middle text-center">Tipo de actividad curricular del plan de estudio</th>
                                        <th rowspan="2" class="align-middle text-center">Nombre de la actividad o asignatura</th>
                                        <th colspan="5" class="text-center">Bibliografía obligatoria</th>
                                        <th colspan="5" class="text-center">Bibliografía complementaria</th>
                                    </tr>
                                    <tr>
                                        <th class="text-center">Título</th>
                                        <th class="text-center">Año</th>
                                        <th class="text-center">N° de ejemplares físicos</th>
                                        <th class="text-center">N° de ejemplares electrónicos</th>
                                        <th class="text-center">% Cobertura</th>
                                        <th class="text-center">Título</th>
                                        <th class="text-center">Año</th>
                                        <th class="text-center">N° de ejemplares físicos</th>
                                        <th class="text-center">N° de ejemplares electrónicos</th>
                                        <th class="text-center">% Cobertura</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# Recorrer asignaturas agrupadas desde el backend #}
                                    {% for codigo, asignatura in asignaturas %}
                                        {% set len_basica = asignatura.basica|length %}
                                        {% set len_complementaria = asignatura.complementaria|length %}
                                        {% set max_filas = len_basica > len_complementaria ? len_basica : len_complementaria %}
                                        {% for i in 0..(max_filas-1) %}
                                            <tr>
                                                {% if i == 0 %}
                                                    <td class="text-center align-middle" rowspan="{{ max_filas }}">{{ asignatura.tipo }}</td>
                                                    <td class="align-middle" rowspan="{{ max_filas }}">{{ asignatura.nombre }}</td>
                                                {% endif %}
                                                {# Bibliografía obligatoria #}
                                                {% set b = asignatura.basica[i] is defined ? asignatura.basica[i] : null %}
                                                <td>{{ b ? b.titulo_declarado : '' }}</td>
                                                <td class="text-center">{{ b ? b.anio_edicion : '' }}</td>
                                                <td class="text-center">
                                                    {% if b %}
                                                        {% if b.ejemplares_impresos == -2 %}
                                                            <span class="text-muted">Sin información</span>
                                                        {% elseif b.ejemplares_impresos == -1 %}
                                                            <span class="text-muted">Sin ejemplares impresos</span>
                                                        {% else %}
                                                            {{ b.ejemplares_impresos }}
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    {% if b %}
                                                        {% if b.ejemplares_digitales == -2 %}
                                                            <span class="text-muted">Sin información</span>
                                                        {% elseif b.ejemplares_digitales == -3 %}
                                                            <span class="text-warning">Ilimitado parcialmente</span>
                                                        {% elseif b.ejemplares_digitales == -1 %}
                                                            <span class="text-muted">Sin ejemplares digitales</span>
                                                        {% elseif b.ejemplares_digitales == 0 %}
                                                            <span class="text-success">Ilimitado</span>
                                                        {% else %}
                                                            {{ b.ejemplares_digitales }}
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">{{ b ? (b.cobertura ~ '%') : '' }}</td>
                                                {# Bibliografía complementaria #}
                                                {% set c = asignatura.complementaria[i] is defined ? asignatura.complementaria[i] : null %}
                                                <td>{{ c ? c.titulo_declarado : '' }}</td>
                                                <td class="text-center">{{ c ? c.anio_edicion : '' }}</td>
                                                <td class="text-center">
                                                    {% if c %}
                                                        {% if c.ejemplares_impresos == -2 %}
                                                            <span class="text-muted">Sin información</span>
                                                        {% elseif c.ejemplares_impresos == -1 %}
                                                            <span class="text-muted">Sin ejemplares impresos</span>
                                                        {% else %}
                                                            {{ c.ejemplares_impresos }}
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    {% if c %}
                                                        {% if c.ejemplares_digitales == -2 %}
                                                            <span class="text-muted">Sin información</span>
                                                        {% elseif c.ejemplares_digitales == -3 %}
                                                            <span class="text-warning">Ilimitado parcialmente</span>
                                                        {% elseif c.ejemplares_digitales == -1 %}
                                                            <span class="text-muted">Sin ejemplares digitales</span>
                                                        {% elseif c.ejemplares_digitales == 0 %}
                                                            <span class="text-success">Ilimitado</span>
                                                        {% else %}
                                                            {{ c.ejemplares_digitales }}
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">{{ c ? (c.cobertura ~ '%') : '' }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-excel {
    background-color: #217346;
    border-color: #217346;
    color: white;
}

.btn-excel:hover {
    background-color: #1e6b3d;
    border-color: #1e6b3d;
    color: white;
}

.nav-tabs .nav-link {
    color: #495057;
}

.nav-tabs .nav-link.active {
    color: #007bff;
    font-weight: 500;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.badge {
    font-size: 0.8em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips si están disponibles
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});

// Función para exportar a CSV
function exportarCSV() {
    {% if sin_datos %}
        Swal.fire({
            icon: 'warning',
            title: 'No hay datos disponibles',
            text: 'No se pueden exportar datos porque no hay reportes generados para esta carrera.',
            confirmButtonText: 'Entendido'
        });
        return;
    {% endif %}
    
    // Obtener datos de ambas tablas
    const datosBasicos = obtenerDatosTabla('tablaBasicas');
    const datosComplementarios = obtenerDatosTabla('tablaComplementarias');
    
    // Crear contenido CSV
    let csvContent = '\uFEFF'; // BOM para UTF-8
    
    // Encabezados
    const headers = [
        'Tipo Cobertura',
        'Código Asignatura',
        'Nombre Asignatura',
        'Tipo Asignatura',
        'Título Declarado',
        'Año de Edición',
        'Ejemplares Impresos',
        'Ejemplares Digitales',
        'Cobertura (%)'
    ];
    csvContent += headers.join(',') + '\n';
    
    // Agregar datos básicos
    datosBasicos.forEach(fila => {
        const row = ['Básica', ...fila];
        csvContent += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
    });
    
    // Agregar datos complementarios
    datosComplementarios.forEach(fila => {
        const row = ['Complementaria', ...fila];
        csvContent += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
    });
    
    // Crear y descargar el archivo
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `Reporte_Fusionado_Coberturas_{{ carrera.sede }}_{{ carrera.codigo }}_{{ carrera.nombre|replace({' ': '_'}) }}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Función para obtener datos de una tabla
function obtenerDatosTabla(tablaId) {
    const tabla = document.getElementById(tablaId);
    const filas = tabla.querySelectorAll('tbody tr');
    const datos = [];
    
    filas.forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        if (celdas.length > 0 && !fila.querySelector('td[colspan]')) {
            const filaData = [];
            
            // Código Asignatura
            filaData.push(celdas[0].textContent.trim());
            // Nombre Asignatura
            filaData.push(celdas[1].textContent.trim());
            // Tipo Asignatura
            filaData.push(celdas[2].textContent.trim());
            // Título Declarado
            filaData.push(celdas[3].textContent.trim());
            // Año de Edición
            filaData.push(celdas[4].textContent.trim());
            // Ejemplares Impresos
            filaData.push(celdas[5].textContent.trim());
            // Ejemplares Digitales
            filaData.push(celdas[6].textContent.trim());
            // Cobertura
            filaData.push(celdas[7].textContent.trim());
            
            datos.push(filaData);
        }
    });
    
    return datos;
}

// Función para exportar a Excel
function exportarExcel() {
    {% if sin_datos %}
        Swal.fire({
            icon: 'warning',
            title: 'No hay datos disponibles',
            text: 'No se pueden exportar datos porque no hay reportes generados para esta carrera.',
            confirmButtonText: 'Entendido'
        });
        return;
    {% endif %}
    
    // Mostrar indicador de carga
    Swal.fire({
        title: 'Generando Excel...',
        text: 'Por favor espere mientras se procesa el archivo',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Construir la URL de exportación
    const exportUrl = '/biblioges/reportes/coberturas-fusionado-excel/{{ carrera.sede_id }}/{{ carrera.carrera_id }}';
    
    // Realizar la petición al servidor
    fetch(exportUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la generación del archivo');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Cerrar el indicador de carga
            Swal.close();
            
            // Crear enlace de descarga
            const link = document.createElement('a');
            link.href = data.url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Mostrar mensaje de éxito
            Swal.fire({
                icon: 'success',
                title: '¡Excel generado!',
                text: 'El archivo se ha descargado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo generar el archivo Excel: ' + error.message
            });
        });
}

// Función para guardar el reporte
function guardarReporte() {
    {% if sin_datos %}
        Swal.fire({
            icon: 'warning',
            title: 'No hay datos disponibles',
            text: 'No se puede guardar el reporte porque no hay datos para guardar.',
            confirmButtonText: 'Entendido'
        });
        return;
    {% endif %}
    
    // Obtener datos de ambas tablas
    const datosBasicos = obtenerDatosTabla('tablaBasicas');
    const datosComplementarios = obtenerDatosTabla('tablaComplementarias');
    
    // Preparar datos para enviar
    const datosReporte = {
        datos_basicos: datosBasicos,
        datos_complementarios: datosComplementarios,
        fecha_medicion: new Date().toISOString(),
        cobertura_basica: {{ cobertura_basica|default('0') }},
        cobertura_complementaria: {{ cobertura_complementaria|default('0') }}
    };
    
    // Mostrar confirmación
    Swal.fire({
        title: '¿Guardar Reporte Fusionado?',
        text: `Se guardará el reporte fusionado con ${datosBasicos.length} registros básicos y ${datosComplementarios.length} registros complementarios.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, guardar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Aquí se implementará la lógica para guardar el reporte
            Swal.fire({
                icon: 'success',
                title: '¡Reporte guardado!',
                text: 'El reporte fusionado se ha guardado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}
</script>
{% endblock %} 