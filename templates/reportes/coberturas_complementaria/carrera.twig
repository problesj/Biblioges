{% extends "base.twig" %}

{% block title %}Coberturas Complementarias{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Coberturas Complementarias</h3>
                    <h5 class="card-subtitle">{{ carrera.sede }} - {{ carrera.codigo }} - {{ carrera.nombre }}</h5>
                </div>
                <div class="card-body">
                    <!-- Botones de acción -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </button>
                                <a href="/biblioges/reportes/coberturas-complementaria-expandido/{{ carrera.sede_id }}/{{ carrera.carrera_id }}?{{ app.request.queryString }}" 
                                   class="btn btn-success">
                                    <i class="fas fa-expand-alt"></i> Reporte Expandido
                                </a>
                                <button type="button" class="btn btn-excel" id="btnExportarExcel">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="exportarCSV()">
                                    <i class="fas fa-file-csv"></i> Exportar CSV
                                </button>
                            </div>
                        </div>
                    </div>

                    <a id="enlaceDescargaExcel" href="#" class="btn btn-success d-none" download target="_blank">Descargar Excel generado</a>

                    <form id="filtroFormacionForm" method="get">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <h6>Selección de Asignaturas de Formación</h6>
                                <p class="text-muted small mb-2">
                                    Tipos de formación disponibles para esta carrera: 
                                    {% for tipo in tipos_formacion_disponibles %}
                                        <span class="badge bg-info">{{ tipo }}</span>
                                    {% endfor %}
                                </p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_basica" name="tipos_formacion[]" value="FORMACION_BASICA" 
                                                   {% if 'FORMACION_BASICA' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_basica">
                                                Formación Básica 
                                                <small class="text-muted">({{ 'FORMACION_BASICA' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_general" name="tipos_formacion[]" value="FORMACION_GENERAL"
                                                   {% if 'FORMACION_GENERAL' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_general">
                                                Formación General
                                                <small class="text-muted">({{ 'FORMACION_GENERAL' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_idiomas" name="tipos_formacion[]" value="FORMACION_IDIOMAS"
                                                   {% if 'FORMACION_IDIOMAS' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_idiomas">
                                                Formación Idiomas
                                                <small class="text-muted">({{ 'FORMACION_IDIOMAS' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_profesional" name="tipos_formacion[]" value="FORMACION_PROFESIONAL"
                                                   {% if 'FORMACION_PROFESIONAL' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_profesional">
                                                Formación Profesional
                                                <small class="text-muted">({{ 'FORMACION_PROFESIONAL' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_valores" name="tipos_formacion[]" value="FORMACION_VALORES"
                                                   {% if 'FORMACION_VALORES' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_valores">
                                                Formación Valores
                                                <small class="text-muted">({{ 'FORMACION_VALORES' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_especialidad" name="tipos_formacion[]" value="FORMACION_ESPECIALIDAD"
                                                   {% if 'FORMACION_ESPECIALIDAD' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_especialidad">
                                                Formación Especialidad
                                                <small class="text-muted">({{ 'FORMACION_ESPECIALIDAD' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="formacion_especial" name="tipos_formacion[]" value="FORMACION_ESPECIAL"
                                                   {% if 'FORMACION_ESPECIAL' in tipos_formacion_seleccionados %}checked{% endif %}>
                                            <label class="form-check-label" for="formacion_especial">
                                                Formación Especial
                                                <small class="text-muted">({{ 'FORMACION_ESPECIAL' in tipos_formacion_disponibles ? 'Disponible' : 'No disponible' }})</small>
                                            </label>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm mt-2">
                                            <i class="fas fa-filter"></i> Aplicar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <div class="table-responsive">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>Bibliografía Complementaria de la Carrera</h6>
                            <span class="badge bg-secondary" id="contador-asignaturas">
                                Mostrando {{ asignaturas|length }} asignaturas
                            </span>
                        </div>
                        <table class="table table-striped table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Código Asignatura</th>
                                    <th>Nombre</th>
                                    <th>Tipo Asignatura</th>
                                    <th>Estado</th>
                                    <th class="text-center"># Títulos Declarados</th>
                                    <th class="text-center"># Títulos Disponibles</th>
                                    <th class="text-center"># Ejemplares Impresos</th>
                                    <th class="text-center"># Ejemplares Digitales</th>
                                    <th class="text-center">Cobertura Complementaria</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for asignatura in asignaturas %}
                                <tr>
                                    <td><strong>{{ asignatura.codigo }}</strong></td>
                                    <td>{{ asignatura.nombre }}</td>
                                    <td>
                                        {% if asignatura.tipo_asignatura == 'REGULAR' %}
                                            <span class="badge bg-success">REGULAR</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_BASICA' %}
                                            <span class="badge bg-primary">Formación Básica</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_GENERAL' %}
                                            <span class="badge bg-info">Formación General</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_IDIOMAS' %}
                                            <span class="badge bg-warning">Formación Idiomas</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_PROFESIONAL' %}
                                            <span class="badge bg-secondary">Formación Profesional</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_VALORES' %}
                                            <span class="badge bg-dark">Formación Valores</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_ESPECIALIDAD' %}
                                            <span class="badge bg-danger">Formación Especialidad</span>
                                        {% elseif asignatura.tipo_asignatura == 'FORMACION_ESPECIAL' %}
                                            <span class="badge bg-purple">Formación Especial</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ asignatura.tipo_asignatura }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if asignatura.estado == 1 or asignatura.estado == 'Activa' %}
                                            <span class="badge bg-success">Activa</span>
                                        {% else %}
                                            <span class="badge bg-danger">No Activa</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ asignatura.titulos_declarados }}</td>
                                    <td class="text-center">{{ asignatura.titulos_disponibles }}</td>
                                    <td class="text-center">
                                        {% if asignatura.ejemplares_impresos == -2 %}
                                            <span class="text-muted">Sin información</span>
                                        {% elseif asignatura.ejemplares_impresos == -1 %}
                                            <span class="text-muted">Sin ejemplares impresos</span>
                                        {% else %}
                                            {{ asignatura.ejemplares_impresos }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if asignatura.ejemplares_digitales == -2 %}
                                            <span class="text-muted">Sin información</span>
                                        {% elseif asignatura.ejemplares_digitales == -3 %}
                                            <span class="text-warning">Ilimitado parcialmente</span>
                                        {% elseif asignatura.ejemplares_digitales < 0 %}
                                            <span class="text-muted">Sin ejemplares digitales</span>
                                        {% elseif asignatura.titulos_disponibles > 0 and asignatura.ejemplares_digitales == 0 %}
                                            <span class="text-success">Ilimitado</span>
                                        {% else %}
                                            {{ asignatura.ejemplares_digitales }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if asignatura.cobertura_complementaria == 100 %}
                                            <span class="badge bg-success">{{ asignatura.cobertura_complementaria }}%</span>
                                        {% elseif asignatura.cobertura_complementaria > 0 %}
                                            <span class="badge bg-warning">{{ asignatura.cobertura_complementaria }}%</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ asignatura.cobertura_complementaria }}%</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="/biblioges/reportes/coberturas-complementaria/{{ carrera.sede_id }}/{{ carrera.carrera_id }}/{{ asignatura.codigo }}" class="btn btn-sm btn-outline-primary" title="Ver títulos declarados">
                                            <i class="fas fa-book"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Tarjetas de totales -->
                    {% if cobertura_complementaria_total %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-calculator"></i> Totales de la Carrera
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <h4 class="text-primary">{{ cobertura_complementaria_total.total_titulos_declarados }}</h4>
                                                <p class="text-muted mb-0">Total Títulos Declarados</p>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <h4 class="text-info">{{ cobertura_complementaria_total.total_titulos_disponibles }}</h4>
                                                <p class="text-muted mb-0">Total Títulos Disponibles</p>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <h4 class="text-success">
                                                    {% if cobertura_complementaria_total.total_ejemplares_impresos == -2 %}
                                                        Sin información
                                                    {% elseif cobertura_complementaria_total.total_ejemplares_impresos == -1 %}
                                                        Sin ejemplares impresos
                                                    {% else %}
                                                        {{ cobertura_complementaria_total.total_ejemplares_impresos }}
                                                    {% endif %}
                                                </h4>
                                                <p class="text-muted mb-0">Total Ejemplares Impresos</p>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="text-center">
                                                <h4 class="text-info">
                                                    {% if cobertura_complementaria_total.total_ejemplares_digitales == -2 %}
                                                        Sin información
                                                    {% elseif cobertura_complementaria_total.total_ejemplares_digitales == -3 %}
                                                        Ilimitado parcialmente
                                                    {% elseif cobertura_complementaria_total.total_ejemplares_digitales < 0 %}
                                                        Sin ejemplares digitales
                                                    {% elseif cobertura_complementaria_total.total_titulos_disponibles > 0 and cobertura_complementaria_total.total_ejemplares_digitales == 0 %}
                                                        Ilimitado
                                                    {% else %}
                                                        {{ cobertura_complementaria_total.total_ejemplares_digitales }}
                                                    {% endif %}
                                                </h4>
                                                <p class="text-muted mb-0">Total Ejemplares Digitales</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <h4 class="{% if cobertura_complementaria_total.cobertura_complementaria_total >= 80 %}text-success{% elseif cobertura_complementaria_total.cobertura_complementaria_total >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                    {{ cobertura_complementaria_total.cobertura_complementaria_total }}%
                                                </h4>
                                                <p class="text-muted mb-0">Cobertura Complementaria de la Carrera</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-excel {
    background-color: #217346;
    border-color: #217346;
    color: white;
}

.btn-excel:hover {
    background-color: #1e6b3d;
    border-color: #1e6b3d;
    color: white;
}

.badge.bg-purple {
    background-color: #6f42c1 !important;
}
</style>

<script>
        // console.log('Script de cobertura complementaria cargado');

// Verificar que jQuery esté disponible antes de ejecutar cualquier código
if (typeof $ === 'undefined') {
                // console.log('jQuery no está disponible - esperando a que se cargue...');
    // Esperar a que jQuery se cargue
    window.addEventListener('load', function() {
        if (typeof $ !== 'undefined') {
            // console.log('jQuery cargado después del evento load');
            initializeExportButton();
        } else {
            console.error('jQuery aún no está disponible después del evento load');
        }
    });
} else {
            // console.log('jQuery ya está disponible');
    // jQuery ya está disponible, ejecutar inmediatamente
    $(document).ready(function() {
        initializeExportButton();
    });
}

function initializeExportButton() {
            // console.log('Inicializando botón de exportación...');
    
    // Verificar que jQuery esté disponible
    if (typeof $ === 'undefined') {
        console.error('jQuery no está disponible en initializeExportButton');
        return;
    } else {
        // console.log('jQuery está disponible, versión:', $.fn.jquery);
    }
    
    // Actualizar contador de asignaturas
    const asignaturas = document.querySelectorAll('tbody tr');
    const contador = document.getElementById('contador-asignaturas');
    if (contador) {
        contador.textContent = `Mostrando ${asignaturas.length} asignaturas`;
    }
    
    // Verificar que el botón existe con jQuery
    if ($('#btnExportarExcel').length > 0) {
        // console.log('Botón exportar Excel encontrado con jQuery');
        
        // Agregar el evento de clic al botón
        $('#btnExportarExcel').click(function() {
            var url = '/biblioges/reportes/coberturas-complementaria-excel/{{ carrera.sede_id }}/{{ carrera.carrera_id }}';
            var btn = $(this);
            btn.prop('disabled', true).text('Generando...');
            
            // Agregar parámetros de filtro si existen
            var queryString = window.location.search;
            if (queryString) {
                url += queryString;
            }
            
            // Mostrar indicador de carga
            Swal.fire({
                title: 'Generando Excel...',
                text: 'Por favor espere mientras se procesa el archivo',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Realizar la petición al servidor
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Error en la generación del archivo');
                        });
                    }
                    
                    // Cerrar el indicador de carga
                    Swal.close();
                    
                    // Obtener el nombre del archivo del header Content-Disposition
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'Reporte_Bibliografia_Complementaria.xlsx';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    // Crear blob y descargar
                    return response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        
                        // Mostrar mensaje de éxito
                        Swal.fire({
                            icon: 'success',
                            title: '¡Excel generado!',
                            text: 'El archivo se ha descargado correctamente',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo generar el archivo Excel: ' + error.message
                    });
                })
                .finally(function() {
                    btn.prop('disabled', false).html('<i class="fas fa-file-excel"></i> Exportar Excel');
                });
        });
    } else {
        console.error('Botón exportar Excel NO encontrado con jQuery');
    }
}

function exportarCSV() {
    const tabla = document.querySelector('table');
    const filas = tabla.querySelectorAll('tbody tr');
    
    let csvContent = '\uFEFF'; // BOM para UTF-8
    csvContent += 'Código Asignatura,Nombre,Tipo Asignatura,Estado,Títulos Declarados,Títulos Disponibles,Ejemplares Impresos,Ejemplares Digitales,Cobertura Complementaria\n';
    
    filas.forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        const filaData = [];
        
        // Código
        filaData.push(`"${celdas[0].textContent.trim()}"`);
        // Nombre
        filaData.push(`"${celdas[1].textContent.trim()}"`);
        // Tipo Asignatura
        filaData.push(`"${celdas[2].textContent.trim()}"`);
        // Estado
        filaData.push(`"${celdas[3].textContent.trim()}"`);
        // Títulos Declarados
        filaData.push(celdas[4].textContent.trim());
        // Títulos Disponibles
        filaData.push(celdas[5].textContent.trim());
        // Ejemplares Impresos
        filaData.push(celdas[6].textContent.trim());
        // Ejemplares Digitales
        filaData.push(celdas[7].textContent.trim());
        // Cobertura
        filaData.push(celdas[8].textContent.trim());
        
        csvContent += filaData.join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'cobertura_complementaria_{{ carrera.codigo|replace({" ": "_"}) }}.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %} 