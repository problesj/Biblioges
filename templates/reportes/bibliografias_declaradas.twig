{% extends "base.twig" %}

{% block title %}Reporte de Bibliografías Declaradas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">
                            <i class="fas fa-book"></i> Reporte de Bibliografías Declaradas
                        </h3>
                        <div>
                            <button type="button" class="btn btn-success" id="btnExportar">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Filtros</h5>
                        </div>
                        <div class="card-body">
                            <!-- Fila de búsqueda general -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="busqueda" placeholder="Buscar..." value="">
                                        <select class="form-select" id="tipo_busqueda" style="max-width: 150px;">
                                            <option value="todos">Todos</option>
                                            <option value="titulo">Título</option>
                                            <option value="autor">Autor</option>
                                            <option value="editorial">Editorial</option>
                                            <option value="asignatura">Asignatura</option>
                                        </select>
                                        <button type="button" class="btn btn-primary" id="btnBuscar">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Fila de filtros específicos -->
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="filtroEstado" class="form-label">Estado</label>
                                    <select class="form-select" id="filtroEstado">
                                        <option value="">Todos los estados</option>
                                        <option value="1">Activo</option>
                                        <option value="0">Inactivo</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filtroTipo" class="form-label">Tipo</label>
                                    <select class="form-select" id="filtroTipo">
                                        <option value="">Todos los tipos</option>
                                        <option value="libro">Libro</option>
                                        <option value="articulo">Artículo</option>
                                        <option value="tesis">Tesis</option>
                                        <option value="software">Software</option>
                                        <option value="sitio_web">Sitio Web</option>
                                        <option value="generico">Genérico</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filtroTipoBibliografia" class="form-label">Tipo de Bibliografía</label>
                                    <select class="form-select" id="filtroTipoBibliografia">
                                        <option value="">Todos los tipos</option>
                                        <option value="basica">Básica</option>
                                        <option value="complementaria">Complementaria</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filtroBibliografiasDisponibles" class="form-label">Bibliografías Disponibles</label>
                                    <select class="form-select" id="filtroBibliografiasDisponibles">
                                        <option value="">Todos</option>
                                        <option value="con_disponibles">Disponibles</option>
                                        <option value="sin_disponibles">No disponibles</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary w-100" id="btnAplicarFiltros">
                                        <i class="fas fa-filter"></i> Aplicar Filtros
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="button" class="btn btn-secondary" id="btnLimpiarFiltros">
                                        <i class="fas fa-times"></i> Limpiar Filtros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table id="tablaBibliografias" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th>Autor(es)</th>
                                    <th>Año Edición</th>
                                    <th>Editorial</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th># Asignaturas</th>
                                    <th># Bibliografías Disponibles</th>
                                    <th>Tipos de Bibliografía</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de carga -->
<div class="modal fade" id="modalCarga" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Generando reporte...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let table;
    
    // Inicializar DataTable
    function inicializarTabla() {
        table = $('#tablaBibliografias').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: '{{ app_url }}reportes/listado-bibliografias/data',
                type: 'GET',
                data: function(d) {
                    // Búsqueda general
                    d.busqueda = $('#busqueda').val();
                    d.tipo_busqueda = $('#tipo_busqueda').val();
                    // Filtros específicos
                    d.estado = $('#filtroEstado').val();
                    d.tipo = $('#filtroTipo').val();
                    d.tipo_bibliografia = $('#filtroTipoBibliografia').val();
                    d.bibliografias_disponibles = $('#filtroBibliografiasDisponibles').val();
                }
            },
            columns: [
                { data: 'titulo' },
                { data: 'autores' },
                { data: 'anio_publicacion' },
                { data: 'editorial' },
                { data: 'tipo' },
                { 
                    data: 'estado',
                    render: function(data) {
                        return data === 'Activo' 
                            ? '<span class="badge bg-success">Activo</span>'
                            : '<span class="badge bg-danger">Inactivo</span>';
                    }
                },
                { 
                    data: 'num_asignaturas',
                    className: 'text-center'
                },
                { 
                    data: 'num_bibliografias_disponibles',
                    className: 'text-center'
                },
                { 
                    data: 'tipos_bibliografias',
                    render: function(data) {
                        if (!data || data === 'Sin asignar') {
                            return '<span class="text-muted">Sin asignar</span>';
                        }
                        return data;
                    }
                }
            ],
            order: [[0, 'asc']],
            pageLength: 25,
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
            },
            responsive: true,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]]
        });
    }
    
    // Búsqueda general
    $('#btnBuscar').click(function() {
        table.ajax.reload();
    });
    
    // Búsqueda al presionar Enter
    $('#busqueda').keypress(function(e) {
        if (e.which == 13) {
            table.ajax.reload();
        }
    });
    
    // Aplicar filtros
    $('#btnAplicarFiltros').click(function() {
        table.ajax.reload();
    });
    
    // Limpiar filtros
    $('#btnLimpiarFiltros').click(function() {
        $('#busqueda').val('');
        $('#tipo_busqueda').val('todos');
        $('#filtroEstado').val('');
        $('#filtroTipo').val('');
        $('#filtroTipoBibliografia').val('');
        $('#filtroBibliografiasDisponibles').val('');
        table.ajax.reload();
    });
    
    // Exportar Excel
    $('#btnExportar').click(function() {
        const btn = $(this);
        const originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Exportando...');
        
        // Mostrar modal de carga
        $('#modalCarga').modal('show');
        
        // Preparar parámetros para la exportación
        const params = new URLSearchParams({
            busqueda: $('#busqueda').val(),
            tipo_busqueda: $('#tipo_busqueda').val(),
            estado: $('#filtroEstado').val(),
            tipo: $('#filtroTipo').val(),
            tipo_bibliografia: $('#filtroTipoBibliografia').val(),
            bibliografias_disponibles: $('#filtroBibliografiasDisponibles').val()
        });
        
        // Crear enlace de descarga
        const link = document.createElement('a');
        link.href = '{{ app_url }}reportes/listado-bibliografias/exportar?' + params.toString();
        link.download = 'reporte_bibliografias_declaradas.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Ocultar modal y restaurar botón
        setTimeout(function() {
            $('#modalCarga').modal('hide');
            btn.prop('disabled', false).html(originalText);
        }, 1000);
    });
    
    // Inicializar tabla
    inicializarTabla();
});
</script>
{% endblock %} 