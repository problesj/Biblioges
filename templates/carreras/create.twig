{% extends "base.twig" %}

{% block title %}Nueva Carrera - Sistema de Bibliografía{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Botón para ocultar/mostrar el panel lateral -->
    <button id="sidebarToggle" class="btn btn-link d-md-none rounded-circle mr-3">
        <i class="fas fa-bars"></i>
    </button>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Nueva Carrera</h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Datos de la Carrera</h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ app_url }}carreras/store" id="form-carrera">
                <!-- Sección 1: Datos básicos -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="nombre" class="form-label">Nombre de la Carrera *</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" 
                                   value="{{ form_data.nombre|default('') }}" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="tipo_programa" class="form-label">Tipo de Programa *</label>
                            <select class="form-select" id="tipo_programa" name="tipo_programa" required>
                                <option value="">Seleccione un tipo</option>
                                <option value="P" {{ form_data.tipo_programa|default('') == 'P' ? 'selected' : '' }}>Pregrado</option>
                                <option value="G" {{ form_data.tipo_programa|default('') == 'G' ? 'selected' : '' }}>Postgrado</option>
                                <option value="O" {{ form_data.tipo_programa|default('') == 'O' ? 'selected' : '' }}>Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" name="estado">
                                <option value="1" {{ form_data.estado|default('1') == '1' ? 'selected' : '' }}>Activo</option>
                                <option value="0" {{ form_data.estado|default('1') == '0' ? 'selected' : '' }}>Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sección 2: Códigos de carrera -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="mb-3">Códigos de Carrera</h6>
                        <div id="codigos-container">
                            {% if form_data.codigos is defined and form_data.codigos|length > 0 %}
                                {% for index, codigo in form_data.codigos %}
                                    {% if codigo is not empty %}
                                    <div class="row mb-3 codigo-row">
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="codigos[]" class="form-label">Código *</label>
                                                <input type="text" class="form-control" name="codigos[]" 
                                                       value="{{ codigo }}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="vigencias_desde[]" class="form-label">Vigencia Desde *</label>
                                                <input type="text" class="form-control" name="vigencias_desde[]" 
                                                       value="{{ form_data.vigencias_desde[index]|default('') }}"
                                                       pattern="\d{6}" title="Formato: AAAAMM" required>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="vigencias_hasta[]" class="form-label">Vigencia Hasta</label>
                                                <input type="text" class="form-control" name="vigencias_hasta[]" 
                                                       value="{{ form_data.vigencias_hasta[index]|default('999999') }}"
                                                       pattern="\d{6}" title="Formato: AAAAMM">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="sedes[]" class="form-label">Sede *</label>
                                                <select class="form-select" name="sedes[]" required>
                                                    <option value="">Seleccione una sede</option>
                                                    {% for sede in sedes %}
                                                    <option value="{{ sede.id }}" {{ form_data.sedes[index]|default('') == sede.id ? 'selected' : '' }}>
                                                        {{ sede.nombre }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="unidades[]" class="form-label">Unidad *</label>
                                                <select class="form-select" name="unidades[]" required>
                                                    <option value="">Seleccione una unidad</option>
                                                    {% for unidad in unidades %}
                                                    <option value="{{ unidad.id }}" {{ form_data.unidades[index]|default('') == unidad.id ? 'selected' : '' }}>
                                                        {{ unidad.nombre }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                            <div class="row mb-3 codigo-row">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="codigos[]" class="form-label">Código *</label>
                                        <input type="text" class="form-control" name="codigos[]" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="vigencias_desde[]" class="form-label">Vigencia Desde *</label>
                                        <input type="text" class="form-control" name="vigencias_desde[]" 
                                               pattern="\d{6}" title="Formato: AAAAMM" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="vigencias_hasta[]" class="form-label">Vigencia Hasta</label>
                                        <input type="text" class="form-control" name="vigencias_hasta[]" 
                                               value="999999" pattern="\d{6}" title="Formato: AAAAMM">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="sedes[]" class="form-label">Sede *</label>
                                        <select class="form-select" name="sedes[]" required>
                                            <option value="">Seleccione una sede</option>
                                            {% for sede in sedes %}
                                            <option value="{{ sede.id }}">{{ sede.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="unidades[]" class="form-label">Unidad *</label>
                                        <select class="form-select" name="unidades[]" required>
                                            <option value="">Seleccione una unidad</option>
                                            {% for unidad in unidades %}
                                            <option value="{{ unidad.id }}">{{ unidad.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="agregar-codigo">
                            <i class="fas fa-plus"></i> Agregar otro código
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                        <a href="{{ app_url }}carreras" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar error de sesión con SweetAlert2 si existe
        {% if session.error %}
        Swal.fire({
            icon: 'error',
            title: 'Error',
            html: `{{ session.error|e('js') }}`
        });
        {% endif %}

        // Función para cargar unidades por sede
        function cargarUnidadesPorSede(sedeSelect) {
            var unidadSelect = sedeSelect.closest('.row').find('select[name="unidades[]"]');
            unidadSelect.html('<option value="">Cargando...</option>');
            
            $.ajax({
                url: '{{ app_url }}api/unidades',
                method: 'GET',
                data: { sede_id: sedeSelect.val() },
                success: function(unidades) {
                    unidadSelect.html('<option value="">Seleccione una unidad</option>');
                    if (Array.isArray(unidades)) {
                        unidades.forEach(function(unidad) {
                            unidadSelect.append('<option value="' + unidad.id + '">' + unidad.nombre + '</option>');
                        });
                    } else {
                        console.error('La respuesta no es un array:', unidades);
                        unidadSelect.append('<option value="">Error al cargar unidades</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar unidades:', error);
                    unidadSelect.html('<option value="">Error al cargar unidades</option>');
                }
            });
        }

        // Función para validar campos de vigencia
        function validarVigencia(input) {
            // Eliminar cualquier carácter que no sea dígito
            var value = input.value.replace(/\D/g, '');
            
            // Limitar a 6 dígitos
            if (value.length > 6) {
                value = value.slice(0, 6);
            }
            
            // Actualizar el valor del campo
            input.value = value;
            
            // Agregar clase de error si no tiene 6 dígitos
            if (value.length !== 6) {
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        }

        // Función para validar duplicados en tiempo real
        function validarDuplicadosEnTiempoReal() {
            var codigosValidos = [];
            var duplicados = [];
            
            $('.codigo-row').each(function() {
                var codigo = $(this).find('input[name="codigos[]"]').val();
                var sede = $(this).find('select[name="sedes[]"]').val();
                var unidad = $(this).find('select[name="unidades[]"]').val();
                
                if (codigo && sede && unidad) {
                    var codigoKey = codigo + '_' + sede + '_' + unidad;
                    if (codigosValidos.indexOf(codigoKey) !== -1) {
                        duplicados.push(codigo);
                        $(this).find('input[name="codigos[]"]').addClass('is-invalid');
                        $(this).find('select[name="sedes[]"]').addClass('is-invalid');
                        $(this).find('select[name="unidades[]"]').addClass('is-invalid');
                    } else {
                        codigosValidos.push(codigoKey);
                        $(this).find('input[name="codigos[]"]').removeClass('is-invalid');
                        $(this).find('select[name="sedes[]"]').removeClass('is-invalid');
                        $(this).find('select[name="unidades[]"]').removeClass('is-invalid');
                    }
                } else {
                    $(this).find('input[name="codigos[]"]').removeClass('is-invalid');
                    $(this).find('select[name="sedes[]"]').removeClass('is-invalid');
                    $(this).find('select[name="unidades[]"]').removeClass('is-invalid');
                }
            });
            
            return duplicados;
        }

        // Agregar eventos para validación en tiempo real
        $(document).on('input change', '.codigo-row input[name="codigos[]"], .codigo-row select[name="sedes[]"], .codigo-row select[name="unidades[]"]', function() {
            validarDuplicadosEnTiempoReal();
        });

        // Clonar fila de código
        $('#agregar-codigo').click(function() {
            var row = $('.codigo-row:first').clone();
            row.find('input').val('');
            row.find('select').val('');
            row.find('input, select').removeClass('is-invalid');
            $('#codigos-container').append(row);
            
            // Agregar evento de cambio de sede a la nueva fila
            row.find('select[name="sedes[]"]').change(function() {
                cargarUnidadesPorSede($(this));
                validarDuplicadosEnTiempoReal();
            });
            
            // Agregar validación a los campos de vigencia
            row.find('input[name^="vigencias_"]').on('input', function() {
                validarVigencia(this);
            });
            
            // Agregar eventos para validación en tiempo real
            row.find('input[name="codigos[]"], select[name="unidades[]"]').on('input change', function() {
                validarDuplicadosEnTiempoReal();
            });
        });

        // Agregar validación a los campos de vigencia existentes
        $('input[name^="vigencias_"]').on('input', function() {
            validarVigencia(this);
        });

        // Agregar evento de cambio de sede a todas las filas existentes
        $('select[name="sedes[]"]').change(function() {
            cargarUnidadesPorSede($(this));
            validarDuplicadosEnTiempoReal();
        });

        // Cargar unidades iniciales si hay una sede seleccionada
        $('select[name="sedes[]"]').each(function() {
            if ($(this).val()) {
                cargarUnidadesPorSede($(this));
            }
        });

        // Cargar unidades para los códigos existentes después de un error
        {% if form_data.codigos is defined and form_data.codigos|length > 0 %}
        setTimeout(function() {
            $('.codigo-row').each(function(index) {
                var sedeSelect = $(this).find('select[name="sedes[]"]');
                if (sedeSelect.val()) {
                    cargarUnidadesPorSede(sedeSelect);
                }
            });
        }, 500);
        {% endif %}

        // Toggle del panel lateral
        $('#sidebarToggle').click(function() {
            $('body').toggleClass('sidebar-toggled');
            $('.sidebar').toggleClass('toggled');
            if ($('.sidebar').hasClass('toggled')) {
                $('.sidebar .collapse').collapse('hide');
            }
        });

        // Manejar el envío del formulario
        $('#form-carrera').on('submit', function(e) {
            e.preventDefault();
            
            // Validar que al menos un código esté completo
            var codigosCompletos = false;
            var vigenciasValidas = true;
            var codigosValidos = [];
            var duplicados = [];
            
            $('.codigo-row').each(function() {
                var codigo = $(this).find('input[name="codigos[]"]').val();
                var sede = $(this).find('select[name="sedes[]"]').val();
                var unidad = $(this).find('select[name="unidades[]"]').val();
                var vigenciaDesde = $(this).find('input[name="vigencias_desde[]"]').val();
                
                if (codigo && sede && unidad && vigenciaDesde) {
                    codigosCompletos = true;
                    
                    // Verificar duplicados en el formulario
                    var codigoKey = codigo + '_' + sede + '_' + unidad;
                    if (codigosValidos.indexOf(codigoKey) !== -1) {
                        duplicados.push(codigo);
                    } else {
                        codigosValidos.push(codigoKey);
                    }
                }
                
                // Validar formato de vigencia
                if (vigenciaDesde && vigenciaDesde.length !== 6) {
                    vigenciasValidas = false;
                    $(this).find('input[name="vigencias_desde[]"]').addClass('is-invalid');
                }
            });

            if (!codigosCompletos) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de validación',
                    text: 'Debe completar al menos un código de carrera con todos sus datos'
                });
                return false;
            }
            
            if (!vigenciasValidas) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de validación',
                    text: 'Los campos de vigencia deben tener exactamente 6 dígitos'
                });
                return false;
            }

            if (duplicados.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Códigos duplicados',
                    text: 'No se permiten códigos duplicados por sede y unidad. Códigos duplicados: ' + duplicados.join(', ')
                });
                return false;
            }

            // Si todo está bien, enviar el formulario
            this.submit();
        });
    });
</script>
{% endblock %} 