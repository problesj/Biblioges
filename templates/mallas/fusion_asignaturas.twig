{% extends "base.twig" %}

{% block title %}Fusión de Asignaturas - {{ carrera.nombre }}{% endblock %}

{% block head %}
<style>
    .fusion-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .fusion-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .fusion-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }
    
    .fusion-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    
    .fusion-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .fusion-body {
        padding: 30px;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        position: relative;
    }
    
    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin: 0 20px;
        position: relative;
        z-index: 2;
    }
    
    .step.active {
        background: #4e73df;
        color: white;
    }
    
    .step.completed {
        background: #28a745;
        color: white;
    }
    
    .step-line {
        position: absolute;
        top: 20px;
        left: 50px;
        right: 50px;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
    }
    
    .step-line.active {
        background: #4e73df;
    }
    
    .step-line.completed {
        background: #28a745;
    }
    
    .step-content {
        display: none;
    }
    
    .step-content.active {
        display: block;
    }
    
    .asignatura-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    
    .asignatura-card:hover {
        border-color: #4e73df;
        box-shadow: 0 5px 15px rgba(78, 115, 223, 0.2);
    }
    
    .asignatura-card.selected {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.15);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .asignatura-card.fusionar {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.05);
    }
    
    .asignatura-card.fusionar:hover {
        border-color: #e0a800;
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
    }
    
    .asignatura-card.fusionar.selected {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.15);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        transform: scale(1.02);
    }
    
    .asignatura-card.fusionar.selected:hover {
        transform: scale(1.03);
    }
    
    /* Estilos para encabezados de asignaturas en paso 2 */
    .asignatura-info-header {
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid;
    }
    
    .asignatura-info-header h6 {
        margin: 0;
        font-weight: 600;
    }
    
    .asignatura-info-header small {
        font-size: 0.85rem;
        opacity: 0.8;
    }
    
    /* Estilos específicos para asignatura principal */
    .asignatura-info-header.principal {
        background: rgba(40, 167, 69, 0.1);
        border-left-color: #28a745;
    }
    
    /* Estilos específicos para asignatura a fusionar */
    .asignatura-info-header.fusionar {
        background: rgba(220, 53, 69, 0.1);
        border-left-color: #dc3545;
    }
    
    /* Indicadores adicionales para asignaturas seleccionadas */
    .asignatura-card.selected::before {
        content: "✓ ASIGNATURA PRINCIPAL";
        position: absolute;
        top: -10px;
        left: 20px;
        background: #28a745;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: bold;
        z-index: 10;
    }
    
    .asignatura-card.fusionar.selected::before {
        content: "⚠ ASIGNATURA A FUSIONAR";
        position: absolute;
        top: -10px;
        left: 20px;
        background: #dc3545;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: bold;
        z-index: 10;
    }
    
    /* Efectos adicionales para asignaturas seleccionadas */
    .asignatura-card.selected {
        transform: scale(1.02);
        animation: pulse 2s infinite;
    }
    
    .asignatura-card.selected:hover {
        transform: scale(1.03);
    }
    
    /* Animación de pulso para asignaturas seleccionadas */
    @keyframes pulse {
        0% { box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
        50% { box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5); }
        100% { box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
    }
    
    @keyframes pulse-red {
        0% { box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); }
        50% { box-shadow: 0 4px 20px rgba(220, 53, 69, 0.5); }
        100% { box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); }
    }
    
    .asignatura-card.fusionar.selected {
        animation: pulse-red 2s infinite;
    }
    
    .asignatura-info h5 {
        margin: 0 0 10px 0;
        color: #333;
        font-weight: 600;
    }
    
    .asignatura-info p {
        margin: 5px 0;
        color: #666;
        font-size: 0.9rem;
    }
    
    /* Mejorar legibilidad en tarjetas seleccionadas */
    .asignatura-card.selected .asignatura-info h5 {
        color: #1e7e34;
        font-weight: 700;
    }
    
    .asignatura-card.fusionar.selected .asignatura-info h5 {
        color: #c82333;
        font-weight: 700;
    }
    
    .asignatura-card.selected .asignatura-info p {
        color: #495057;
        font-weight: 500;
    }
    
    .asignatura-card.fusionar.selected .asignatura-info p {
        color: #495057;
        font-weight: 500;
    }
    
    .codigos-badge {
        display: inline-block;
        background: #4e73df;
        color: white;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 0.8rem;
        margin: 2px;
    }
    
    .bibliografia-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
    }
    
    .bibliografia-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    
    .bibliografia-header h6 {
        margin: 0;
        flex: 1;
    }
    
    .bibliografia-id {
        background: #6c757d;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
        margin-left: 10px;
    }
    
    .bibliografia-item.duplicada {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.05);
    }
    
    .bibliografia-item.duplicada .duplicate-warning {
        color: #dc3545;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .bibliografia-item.duplicada .bibliografia-id {
        background: #dc3545;
        color: white;
    }
    
    .bibliografia-accion {
        margin-top: 10px;
    }
    
    .btn-fusion {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-fusion:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(78, 115, 223, 0.3);
    }
    
    .btn-fusion:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-secondary-custom {
        background: #6c757d;
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary-custom:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
        padding: 15px 20px;
        margin: 15px 0;
    }
    
    .alert-success {
        background: rgba(40, 167, 69, 0.1);
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .alert-danger {
        background: rgba(220, 53, 69, 0.1);
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="fusion-container">
    <div class="container">
        <!-- Header -->
        <div class="fusion-card">
            <div class="fusion-header">
                <h2><i class="fas fa-object-group"></i> Fusión de Asignaturas</h2>
                <p>{{ carrera.nombre }} - {{ carrera.codigos_carrera|join(', ') }}</p>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="fusion-card">
            <div class="fusion-body">
                <div class="step-indicator">
                    <div class="step-line" id="stepLine"></div>
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                    <div class="step" id="step3">3</div>
                    <div class="step" id="step4">4</div>
                </div>
                
                <div class="text-center mb-4">
                    <h4 id="stepTitle">Paso 1: Seleccionar Asignaturas</h4>
                    <p id="stepDescription">Selecciona la asignatura principal y la asignatura que deseas fusionar</p>
                </div>
            </div>
        </div>

        <!-- Step 1: Selección de Asignaturas -->
        <div class="step-content active" id="stepContent1">
            <div class="fusion-card">
                <div class="fusion-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-star"></i> Asignatura Principal
                            </h5>
                            <div id="asignaturasPrincipal">
                                {% for asignatura in carrera.asignaturas %}
                                <div class="asignatura-card" data-id="{{ asignatura.id }}" data-step="principal">
                                    <div class="asignatura-info">
                                        <h5>{{ asignatura.nombre }}</h5>
                                        <p><strong>Tipo:</strong> {{ asignatura.tipo }}</p>
                                        <p><strong>Semestre:</strong> {{ asignatura.semestre }}</p>
                                        <p><strong>Estado:</strong> 
                                            <span class="badge badge-{{ asignatura.estado ? 'success' : 'danger' }}">
                                                {{ asignatura.estado ? 'Activa' : 'Inactiva' }}
                                            </span>
                                        </p>
                                        {% if asignatura.codigos %}
                                        <p><strong>Códigos:</strong></p>
                                        {% for codigo in asignatura.codigos %}
                                        <span class="codigos-badge">{{ codigo }}</span>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="text-warning mb-3">
                                <i class="fas fa-exchange-alt"></i> Asignatura a Fusionar
                            </h5>
                            <div id="asignaturasFusionar">
                                {% for asignatura in carrera.asignaturas %}
                                <div class="asignatura-card fusionar" data-id="{{ asignatura.id }}" data-step="fusionar">
                                    <div class="asignatura-info">
                                        <h5>{{ asignatura.nombre }}</h5>
                                        <p><strong>Tipo:</strong> {{ asignatura.tipo }}</p>
                                        <p><strong>Semestre:</strong> {{ asignatura.semestre }}</p>
                                        <p><strong>Estado:</strong> 
                                            <span class="badge badge-{{ asignatura.estado ? 'success' : 'danger' }}">
                                                {{ asignatura.estado ? 'Activa' : 'Inactiva' }}
                                            </span>
                                        </p>
                                        {% if asignatura.codigos %}
                                        <p><strong>Códigos:</strong></p>
                                        {% for codigo in asignatura.codigos %}
                                        <span class="codigos-badge">{{ codigo }}</span>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-fusion" id="btnContinuarPaso1" disabled>
                            Continuar <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Revisión de Bibliografías -->
        <div class="step-content" id="stepContent2">
            <div class="fusion-card">
                <div class="fusion-body">
                    <div id="bibliografiasContainer">
                        <div class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Cargando...</span>
                            </div>
                            <p class="mt-3">Analizando bibliografías...</p>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary-custom me-3" id="btnVolverPaso1">
                            <i class="fas fa-arrow-left"></i> Volver
                        </button>
                        <button class="btn btn-fusion" id="btnContinuarPaso2" disabled>
                            Continuar <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Revisión de Mallas Vinculadas -->
        <div class="step-content" id="stepContent3">
            <div class="fusion-card">
                <div class="fusion-body">
                    <div id="mallasContainer">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-link"></i> Mallas Vinculadas a la Asignatura Principal
                                </h5>
                                <div id="mallasVinculadasPrincipal">
                                    <!-- Se llena dinámicamente -->
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="text-warning mb-3">
                                    <i class="fas fa-link"></i> Mallas Vinculadas a la Asignatura a Fusionar
                                </h5>
                                <div id="mallasVinculadasFusionar">
                                    <!-- Se llena dinámicamente -->
                                </div>
                            </div>
                        </div>
                        <div id="mallasDetalles">
                            <!-- Se llena dinámicamente -->
                        </div>
                        <div class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Cargando...</span>
                            </div>
                            <p class="mt-3">Analizando mallas vinculadas...</p>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary-custom me-3" id="btnVolverPaso2">
                            <i class="fas fa-arrow-left"></i> Volver
                        </button>
                        <button class="btn btn-fusion" id="btnContinuarPaso3" disabled>
                            Continuar <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Confirmación y Procesamiento -->
        <div class="step-content" id="stepContent4">
            <div class="fusion-card">
                <div class="fusion-body">
                    <div id="resumenFusion">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> Resumen de la Fusión</h5>
                            <p>Revisa los detalles antes de proceder con la fusión:</p>
                        </div>
                        
                        <div id="resumenDetalles">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary-custom me-3" id="btnVolverPaso3">
                            <i class="fas fa-arrow-left"></i> Volver
                        </button>
                        <button class="btn btn-fusion" id="btnProcesarFusion">
                            <i class="fas fa-magic"></i> Procesar Fusión
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading y Resultados -->
        <div id="loadingFusion" class="fusion-card" style="display: none;">
            <div class="fusion-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Procesando...</span>
                </div>
                <h5 class="mt-3">Procesando fusión de asignaturas...</h5>
                <p>Por favor, no cierres esta ventana.</p>
            </div>
        </div>

        <div id="resultadoFusion" class="fusion-card" style="display: none;">
            <div class="fusion-body">
                <div id="mensajeResultado">
                    <!-- Se llena dinámicamente -->
                </div>
                
                <div class="text-center mt-4">
                    <a href="{{ app_url }}mallas/{{ carrera.id }}" class="btn btn-fusion">
                        <i class="fas fa-eye"></i> Ver Malla
                    </a>
                    <a href="{{ app_url }}mallas" class="btn btn-secondary-custom ms-3">
                        <i class="fas fa-list"></i> Volver a Mallas
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let asignaturaPrincipal = null;
let asignaturaFusionar = null;
let bibliografiasData = null;

// Step 1: Selección de asignaturas
document.querySelectorAll('[data-step="principal"]').forEach(card => {
    card.addEventListener('click', function() {
        // Deseleccionar todas las asignaturas principales
        document.querySelectorAll('[data-step="principal"]').forEach(c => c.classList.remove('selected'));
        // Seleccionar la actual
        this.classList.add('selected');
        asignaturaPrincipal = this.dataset.id;
        verificarPaso1();
    });
});

document.querySelectorAll('[data-step="fusionar"]').forEach(card => {
    card.addEventListener('click', function() {
        // Deseleccionar todas las asignaturas a fusionar
        document.querySelectorAll('[data-step="fusionar"]').forEach(c => c.classList.remove('selected'));
        // Seleccionar la actual
        this.classList.add('selected');
        asignaturaFusionar = this.dataset.id;
        verificarPaso1();
    });
});

function verificarPaso1() {
    const btnContinuar = document.getElementById('btnContinuarPaso1');
    if (asignaturaPrincipal && asignaturaFusionar && asignaturaPrincipal !== asignaturaFusionar) {
        btnContinuar.disabled = false;
    } else {
        btnContinuar.disabled = true;
    }
}

document.getElementById('btnContinuarPaso1').addEventListener('click', function() {
    if (asignaturaPrincipal && asignaturaFusionar) {
        irAPaso(2);
        cargarBibliografias();
    }
});

// Step 2: Carga de bibliografías
function cargarBibliografias() {
    const container = document.getElementById('bibliografiasContainer');
    container.innerHTML = '<div class="loading"><div class="spinner-border text-primary" role="status"><span class="sr-only">Cargando...</span></div><p class="mt-3">Analizando bibliografías...</p></div>';
    
    fetch('{{ app_url }}api/mallas/bibliografias-fusion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            asignatura_principal_id: asignaturaPrincipal,
            asignatura_fusionar_id: asignaturaFusionar,
            carrera_id: {{ carrera.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Respuesta de bibliografías:', data);
        if (data.success) {
            bibliografiasData = data;
            console.log('bibliografiasData establecido:', bibliografiasData);
            mostrarBibliografias(data);
        } else {
            Swal.fire({
                title: 'Error al Cargar Bibliografías',
                text: data.message,
                icon: 'error',
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Entendido'
            });
            container.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        Swal.fire({
            title: 'Error al Cargar Bibliografías',
            text: `Error al cargar bibliografías: ${error.message}`,
            icon: 'error',
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Entendido'
        });
        container.innerHTML = `<div class="alert alert-danger">Error al cargar bibliografías: ${error.message}</div>`;
    });
}

function mostrarBibliografias(data) {
    const container = document.getElementById('bibliografiasContainer');
    
    // Obtener información de las asignaturas seleccionadas
    const asignaturaPrincipalEl = document.querySelector(`[data-step="principal"].selected`);
    const asignaturaFusionarEl = document.querySelector(`[data-step="fusionar"].selected`);
    
    let nombrePrincipal = 'Asignatura Principal';
    let nombreFusionar = 'Asignatura a Fusionar';
    let codigosPrincipal = '';
    let codigosFusionar = '';
    
    if (asignaturaPrincipalEl) {
        const tituloEl = asignaturaPrincipalEl.querySelector('h5');
        const codigosEls = asignaturaPrincipalEl.querySelectorAll('.codigos-badge');
        if (tituloEl) nombrePrincipal = tituloEl.textContent;
        if (codigosEls.length > 0) {
            codigosPrincipal = Array.from(codigosEls).map(el => el.textContent).join(', ');
        }
    }
    
    if (asignaturaFusionarEl) {
        const tituloEl = asignaturaFusionarEl.querySelector('h5');
        const codigosEls = asignaturaFusionarEl.querySelectorAll('.codigos-badge');
        if (tituloEl) nombreFusionar = tituloEl.textContent;
        if (codigosEls.length > 0) {
            codigosFusionar = Array.from(codigosEls).map(el => el.textContent).join(', ');
        }
    }
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-book"></i> Bibliografías de la Asignatura Principal
                </h5>
                <div class="asignatura-info-header principal">
                    <h6 class="text-primary mb-0">
                        <i class="fas fa-star"></i> ${nombrePrincipal}
                        ${codigosPrincipal ? `<br><small class="text-muted">Códigos: ${codigosPrincipal}</small>` : ''}
                    </h6>
                </div>
                <div id="bibliografiasPrincipal">
    `;
    
    if (data.bibliografias_principal.length > 0) {
        data.bibliografias_principal.forEach(bib => {
            html += `
                <div class="bibliografia-item">
                    <div class="bibliografia-header">
                        <h6>${bib.titulo}</h6>
                        <span class="bibliografia-id">ID: ${bib.id}</span>
                    </div>
                    <p><strong>Tipo:</strong> ${bib.tipo_bibliografia}</p>
                    <p><strong>Formato:</strong> ${bib.formato}</p>
                    <p><strong>Estado:</strong> ${bib.estado}</p>
                </div>
            `;
        });
    } else {
        html += '<p class="text-muted">No hay bibliografías declaradas</p>';
    }
    
    html += `
                </div>
            </div>
            
            <div class="col-md-6">
                <h5 class="text-warning mb-3">
                    <i class="fas fa-book"></i> Bibliografías de la Asignatura a Fusionar
                </h5>
                <div class="asignatura-info-header fusionar">
                    <h6 class="text-warning mb-0">
                        <i class="fas fa-exchange-alt"></i> ${nombreFusionar}
                        ${codigosFusionar ? `<br><small class="text-muted">Códigos: ${codigosFusionar}</small>` : ''}
                    </h6>
                </div>
                <div id="bibliografiasFusionar">
    `;
    
    if (data.bibliografias_fusionar.length > 0) {
        data.bibliografias_fusionar.forEach(bib => {
            const esDuplicada = data.bibliografias_duplicadas.some(d => d.id === bib.id);
            const claseDuplicada = esDuplicada ? 'duplicada' : '';
            const warningDuplicada = esDuplicada ? '<div class="duplicate-warning"><i class="fas fa-exclamation-triangle"></i> Bibliografía duplicada</div>' : '';
            
            html += `
                <div class="bibliografia-item ${claseDuplicada}">
                    ${warningDuplicada}
                    <div class="bibliografia-header">
                        <h6>${bib.titulo}</h6>
                        <span class="bibliografia-id">ID: ${bib.id}</span>
                    </div>
                    <p><strong>Tipo:</strong> ${bib.tipo_bibliografia}</p>
                    <p><strong>Formato:</strong> ${bib.formato}</p>
                    <p><strong>Estado:</strong> ${bib.estado}</p>
                    <div class="bibliografia-accion">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="accion_${bib.id}" id="fusionar_${bib.id}" value="fusionar" ${!esDuplicada ? 'checked' : ''}>
                            <label class="form-check-label" for="fusionar_${bib.id}">
                                Fusionar con la principal
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="accion_${bib.id}" id="mantener_${bib.id}" value="mantener" ${esDuplicada ? 'checked' : ''}>
                            <label class="form-check-label" for="mantener_${bib.id}">
                                Mantener solo en la original
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="accion_${bib.id}" id="eliminar_${bib.id}" value="eliminar">
                            <label class="form-check-label" for="eliminar_${bib.id}">
                                Eliminar bibliografía
                            </label>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        html += '<p class="text-muted">No hay bibliografías declaradas</p>';
    }
    
    html += `
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-4">
            <h6><i class="fas fa-info-circle"></i> Instrucciones:</h6>
            <ul class="mb-0">
                <li><strong>Fusionar:</strong> La bibliografía se vinculará a la asignatura principal</li>
                <li><strong>Mantener solo en la original:</strong> La bibliografía permanecerá solo en la asignatura a fusionar</li>
                <li><strong>Eliminar bibliografía:</strong> Se eliminará la vinculación de la bibliografía con la asignatura a fusionar</li>
                <li>Las bibliografías duplicadas se marcan automáticamente</li>
            </ul>
        </div>
    `;
    
    // Agregar resumen de bibliografías
    html += `
        <div class="alert alert-info mt-4">
            <h6><i class="fas fa-list"></i> Resumen de Bibliografías:</h6>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Asignatura Principal:</strong> ${data.bibliografias_principal.length} bibliografía(s)</p>
                    <small class="text-muted">
                        IDs: ${data.bibliografias_principal.length > 0 ? data.bibliografias_principal.map(b => b.id).join(', ') : 'N/A'}
                    </small>
                </div>
                <div class="col-md-6">
                    <p><strong>Asignatura a Fusionar:</strong> ${data.bibliografias_fusionar.length} bibliografía(s)</p>
                    <small class="text-muted">
                        IDs: ${data.bibliografias_fusionar.length > 0 ? data.bibliografias_fusionar.map(b => b.id).join(', ') : 'N/A'}
                    </small>
                </div>
            </div>
            ${data.bibliografias_duplicadas.length > 0 ? `
                <hr>
                <p><strong>Bibliografías Duplicadas:</strong> ${data.bibliografias_duplicadas.length} encontrada(s)</p>
                <small class="text-muted">
                    IDs: ${data.bibliografias_duplicadas.map(b => b.id).join(', ')}
                </small>
            ` : ''}
        </div>
    `;
    
    // Agregar información de mallas vinculadas si está disponible
    if (data.tiene_otras_mallas) {
        html += `
            <div class="alert alert-warning mt-4">
                <h6><i class="fas fa-exclamation-triangle"></i> Atención:</h6>
                <p>La asignatura a fusionar está vinculada a <strong>${data.otras_mallas.length} otra(s) malla(s)</strong> además de la actual.</p>
                <p>En el siguiente paso podrás revisar estas mallas y decidir si continuar con la fusión.</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
    document.getElementById('btnContinuarPaso2').disabled = false;
}

document.getElementById('btnContinuarPaso2').addEventListener('click', function() {
    irAPaso(3); // Cambiar al paso 3
});

document.getElementById('btnVolverPaso1').addEventListener('click', function() {
    irAPaso(1);
});

// Step 3: Carga de mallas vinculadas
function cargarMallasVinculadas() {
    const container = document.getElementById('mallasContainer');
    
    // Obtener información de las asignaturas seleccionadas
    const asignaturaPrincipalEl = document.querySelector(`[data-step="principal"].selected`);
    const asignaturaFusionarEl = document.querySelector(`[data-step="fusionar"].selected`);
    
    let nombrePrincipal = 'Asignatura Principal';
    let nombreFusionar = 'Asignatura a Fusionar';
    let codigosPrincipal = '';
    let codigosFusionar = '';
    
    if (asignaturaPrincipalEl) {
        const tituloEl = asignaturaPrincipalEl.querySelector('h5');
        const codigosEls = asignaturaPrincipalEl.querySelectorAll('.codigos-badge');
        if (tituloEl) nombrePrincipal = tituloEl.textContent;
        if (codigosEls.length > 0) {
            codigosPrincipal = Array.from(codigosEls).map(el => el.textContent).join(', ');
        }
    }
    
    if (asignaturaFusionarEl) {
        const tituloEl = asignaturaFusionarEl.querySelector('h5');
        const codigosEls = asignaturaFusionarEl.querySelectorAll('.codigos-badge');
        if (tituloEl) nombreFusionar = tituloEl.textContent;
        if (codigosEls.length > 0) {
            codigosFusionar = Array.from(codigosEls).map(el => el.textContent).join(', ');
        }
    }
    
    // Actualizar los encabezados con información de las asignaturas
    document.querySelector('#mallasVinculadasPrincipal').innerHTML = `
        <div class="asignatura-info-header principal">
            <h6 class="text-primary mb-0">
                <i class="fas fa-star"></i> ${nombrePrincipal}
                ${codigosPrincipal ? `<br><small class="text-muted">Códigos: ${codigosPrincipal}</small>` : ''}
            </h6>
        </div>
    `;
    
    document.querySelector('#mallasVinculadasFusionar').innerHTML = `
        <div class="asignatura-info-header fusionar">
            <h6 class="text-warning mb-0">
                <i class="fas fa-exchange-alt"></i> ${nombreFusionar}
                ${codigosFusionar ? `<br><small class="text-muted">Códigos: ${codigosFusionar}</small>` : ''}
            </h6>
        </div>
    `;
    
    // Mostrar loading en el contenedor de detalles
    document.getElementById('mallasDetalles').innerHTML = '<div class="loading"><div class="spinner-border text-primary" role="status"><span class="sr-only">Cargando...</span></div><p class="mt-3">Analizando mallas vinculadas...</p></div>';

    console.log('cargarMallasVinculadas llamado');
    console.log('bibliografiasData:', bibliografiasData);

    // Usar los datos ya obtenidos del paso anterior
    if (bibliografiasData) {
        console.log('Mallas principal:', bibliografiasData.mallas_principal);
        console.log('Mallas fusionar:', bibliografiasData.mallas_fusionar);
        console.log('Otras mallas:', bibliografiasData.otras_mallas);
        console.log('Tiene otras mallas:', bibliografiasData.tiene_otras_mallas);
        mostrarMallasVinculadas(bibliografiasData);
    } else {
        Swal.fire({
            title: 'Error al Cargar Mallas',
            text: 'No se encontraron datos de bibliografías',
            icon: 'warning',
            confirmButtonColor: '#ffc107',
            confirmButtonText: 'Entendido'
        });
        document.getElementById('mallasDetalles').innerHTML = '<div class="alert alert-danger">Error: No se encontraron datos de bibliografías</div>';
    }
}

function mostrarMallasVinculadas(data) {
    console.log('mostrarMallasVinculadas llamado con data:', data);
    const container = document.getElementById('mallasDetalles');
    
    let html = '';
    
    // Agregar información sobre otras mallas si existe
    if (data.tiene_otras_mallas && data.otras_mallas.length > 0) {
        html += `
            <div class="alert alert-warning mt-4">
                <h6><i class="fas fa-exclamation-triangle"></i> Atención:</h6>
                <p>La asignatura a fusionar está vinculada a <strong>${data.otras_mallas.length} otra(s) malla(s)</strong> además de la actual:</p>
                <ul>
        `;
        
        data.otras_mallas.forEach(malla => {
            html += `<li><strong>${malla.carrera_nombre}</strong> (ID: ${malla.carrera_id}) - Semestre: ${malla.semestre}</li>`;
        });
        
        html += `
                </ul>
                <p class="mb-0">En el siguiente paso podrás decidir si continuar con la fusión en todas las mallas o solo en la actual.</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
    document.getElementById('btnContinuarPaso3').disabled = false;
}

document.getElementById('btnContinuarPaso3').addEventListener('click', function() {
    irAPaso(4);
    mostrarResumen();
});

document.getElementById('btnVolverPaso2').addEventListener('click', function() {
    irAPaso(2);
});

// Step 3: Resumen y procesamiento
function mostrarResumen() {
    const container = document.getElementById('resumenDetalles');
    
    // Obtener nombres de las asignaturas
    const asignaturaPrincipalEl = document.querySelector(`[data-id="${asignaturaPrincipal}"]`);
    const asignaturaFusionarEl = document.querySelector(`[data-id="${asignaturaFusionar}"]`);
    
    const nombrePrincipal = asignaturaPrincipalEl.querySelector('h5').textContent;
    const nombreFusionar = asignaturaFusionarEl.querySelector('h5').textContent;
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-primary">Asignatura Principal</h6>
                        <p class="card-text"><strong>${nombrePrincipal}</strong></p>
                        <p class="card-text">Esta asignatura mantendrá su identidad y recibirá los códigos y bibliografías seleccionadas.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-warning">Asignatura a Fusionar</h6>
                        <p class="card-text"><strong>${nombreFusionar}</strong></p>
                        <p class="card-text">Esta asignatura será eliminada de la malla después de la fusión.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar información sobre mallas vinculadas si está disponible
    if (bibliografiasData && bibliografiasData.tiene_otras_mallas) {
        html += `
            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle"></i> Información sobre Otras Mallas:</h6>
                <p>La asignatura a fusionar está vinculada a <strong>${bibliografiasData.otras_mallas.length} otra(s) malla(s)</strong>.</p>
                <p>Durante el proceso de fusión, se te consultará si deseas continuar con estas mallas.</p>
                <p>Si continúas, la asignatura principal reemplazará a la asignatura a fusionar en todas las mallas donde aparezca.</p>
            </div>
        `;
    }
    
    html += `
        <div class="alert alert-warning mt-4">
            <h6><i class="fas fa-exclamation-triangle"></i> Importante:</h6>
            <p class="mb-0">Esta acción no se puede deshacer. Asegúrate de que la información sea correcta antes de proceder.</p>
        </div>
    `;
    
    container.innerHTML = html;
}

document.getElementById('btnProcesarFusion').addEventListener('click', function() {
    Swal.fire({
        title: '¿Confirmar Fusión?',
        text: '¿Estás seguro de que deseas proceder con la fusión? Esta acción no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, Proceder',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            procesarFusion();
        }
    });
});

document.getElementById('btnVolverPaso3').addEventListener('click', function() {
    irAPaso(3);
});

// Función para procesar la fusión
async function procesarFusion() {
    // Ocultar contenido y mostrar loading
    document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
    document.getElementById('loadingFusion').style.display = 'block';
    
    // Recolectar acciones de bibliografías
    const accionesBibliografias = {};
    if (bibliografiasData && bibliografiasData.bibliografias_fusionar) {
        bibliografiasData.bibliografias_fusionar.forEach(bib => {
            const radioSeleccionado = document.querySelector(`input[name="accion_${bib.id}"]:checked`);
            if (radioSeleccionado) {
                accionesBibliografias[bib.id] = radioSeleccionado.value;
            }
        });
    }
    
    // Determinar si continuar con otras mallas
    let continuarConOtrasMallas = false;
    if (bibliografiasData && bibliografiasData.tiene_otras_mallas) {
        // Usar SweetAlert2 para confirmación más elegante
        const result = await Swal.fire({
            title: 'Múltiples Mallas Detectadas',
            html: `
                <p>La asignatura a fusionar está vinculada a otras mallas.</p>
                <p><strong>¿Deseas continuar con la fusión?</strong></p>
                <div class="text-left">
                    <p>Si continúas:</p>
                    <ul class="text-left">
                        <li>• La asignatura principal reemplazará a la asignatura a fusionar en <strong>TODAS</strong> las mallas</li>
                        <li>• Se transferirán todos los códigos, unidades y cantidades de alumnos</li>
                        <li>• Las bibliografías se fusionarán inteligentemente evitando duplicados</li>
                        <li>• El resultado será una sola asignatura principal en todas las carreras</li>
                    </ul>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, Continuar',
            cancelButtonText: 'Cancelar',
            width: '600px'
        });
        
        if (result.isConfirmed) {
            continuarConOtrasMallas = true;
        } else {
            // Si el usuario cancela, detener el proceso
            return;
        }
    }
    
    // Enviar petición de fusión
    fetch('{{ app_url }}api/mallas/procesar-fusion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            asignatura_principal_id: asignaturaPrincipal,
            asignatura_fusionar_id: asignaturaFusionar,
            acciones_bibliografias: accionesBibliografias,
            carrera_id: {{ carrera.id }},
            continuar_con_otras_mallas: continuarConOtrasMallas
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingFusion').style.display = 'none';
        
        if (data.success) {
            mostrarResultado(true, data.message, data.resumen_fusion);
        } else {
            mostrarResultado(false, data.message);
        }
    })
    .catch(error => {
        document.getElementById('loadingFusion').style.display = 'none';
        mostrarResultado(false, `Error al procesar la fusión: ${error.message}`);
    });
}

function mostrarResultado(success, message, resumenFusion = null) {
    if (success) {
        let detallesHTML = '';
        
        if (resumenFusion) {
            detallesHTML = `
                <hr>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-list"></i> Resumen de la Fusión:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Mallas procesadas:</strong> ${resumenFusion.mallas_procesadas}</li>
                            <li><strong>Conflictos resueltos:</strong> ${resumenFusion.conflictos_resueltos}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-university"></i> Carreras Afectadas:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total de carreras:</strong> ${resumenFusion.carreras_afectadas.length}</li>
                            ${resumenFusion.carreras_conflictivas.length > 0 ? 
                                `<li><strong>Carreras con conflictos:</strong> ${resumenFusion.carreras_conflictivas.join(', ')}</li>` : 
                                '<li><strong>Sin conflictos detectados</strong></li>'
                            }
                        </ul>
                    </div>
                </div>
            `;
        }
        
        Swal.fire({
            title: '¡Fusión Completada!',
            html: `
                <div class="text-success">
                    <i class="fas fa-check-circle fa-2x mb-3"></i>
                    <p class="mb-3">${message}</p>
                    ${detallesHTML}
                </div>
            `,
            icon: 'success',
            confirmButtonColor: '#28a745',
            confirmButtonText: 'Entendido',
            width: '700px'
        }).then(() => {
            // Mostrar también en el contenedor para mantener consistencia
            const container = document.getElementById('mensajeResultado');
            container.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle"></i> ¡Fusión Completada!</h5>
                    <p class="mb-0">${message}</p>
                    ${detallesHTML}
                </div>
            `;
            document.getElementById('resultadoFusion').style.display = 'block';
        });
    } else {
        Swal.fire({
            title: 'Error en la Fusión',
            text: message,
            icon: 'error',
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Entendido'
        }).then(() => {
            // Mostrar también en el contenedor para mantener consistencia
            const container = document.getElementById('mensajeResultado');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-times-circle"></i> Error en la Fusión</h5>
                    <p class="mb-0">${message}</p>
                </div>
            `;
            document.getElementById('resultadoFusion').style.display = 'block';
        });
    }
}

// Función para cambiar de paso
function irAPaso(paso) {
    // Actualizar indicadores de paso
    const steps = [1, 2, 3, 4]; // Pasos actualizados
    
    steps.forEach((stepNum, index) => {
        const step = document.getElementById(`step${stepNum}`);
        const stepContent = document.getElementById(`stepContent${stepNum}`);
        
        if (stepNum < paso) {
            step.classList.remove('active');
            step.classList.add('completed');
        } else if (stepNum === paso) {
            step.classList.remove('completed');
            step.classList.add('active');
        } else {
            step.classList.remove('active', 'completed');
        }
        
        if (stepContent) {
            stepContent.classList.remove('active');
        }
    });
    
    // Actualizar línea de conexión
    const stepLine = document.getElementById('stepLine');
    if (paso > 1) {
        stepLine.classList.add('completed');
    } else {
        stepLine.classList.remove('completed');
    }
    
    // Mostrar contenido del paso actual
    const currentStepContent = document.getElementById(`stepContent${paso}`);
    if (currentStepContent) {
        currentStepContent.classList.add('active');
    }
    
    // Actualizar título y descripción
    const titulos = [
        'Paso 1: Seleccionar Asignaturas',
        'Paso 2: Revisión de Bibliografías',
        'Paso 3: Revisión de Mallas Vinculadas',
        'Paso 4: Confirmación y Procesamiento'
    ];
    
    const descripciones = [
        'Selecciona la asignatura principal y la asignatura que deseas fusionar',
        'Revisa las bibliografías declaradas y define cómo manejarlas',
        'Revisa las mallas vinculadas a ambas asignaturas',
        'Confirma los detalles y procede con la fusión'
    ];
    
    const stepIndex = steps.indexOf(paso);
    if (stepIndex !== -1) {
        document.getElementById('stepTitle').textContent = titulos[stepIndex];
        document.getElementById('stepDescription').textContent = descripciones[stepIndex];
    }
    
    // Ejecutar acciones específicas según el paso
    if (paso === 3) {
        // Cargar mallas vinculadas cuando se llega al paso 3
        cargarMallasVinculadas();
    }
}
</script>
{% endblock %}
