{% extends "base.twig" %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">
                            <i class="fas fa-users"></i> Gestión de Usuarios
                        </h3>
                        <div>
                            <a href="{{ app_url }}usuarios/create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Nuevo Usuario
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Filtros</h5>
                        </div>
                        <div class="card-body">
                            <form id="filtrosForm" method="GET">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="search" class="form-label">Buscar</label>
                                        <input type="text" class="form-control" id="search" name="search" 
                                               placeholder="Nombre, email o RUT" value="{{ filters.search }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="rol" class="form-label">Rol</label>
                                        <select class="form-select" id="rol" name="rol">
                                            <option value="">Todos los roles</option>
                                            {% for key, value in roles %}
                                                <option value="{{ key }}" {{ filters.rol == key ? 'selected' : '' }}>
                                                    {{ value }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="estado" class="form-label">Estado</label>
                                        <select class="form-select" id="estado" name="estado">
                                            <option value="">Todos los estados</option>
                                            {% for key, value in estados %}
                                                <option value="{{ key }}" {{ filters.estado == key ? 'selected' : '' }}>
                                                    {{ value }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search"></i> Filtrar
                                        </button>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <a href="{{ app_url }}usuarios" class="btn btn-secondary">
                                            <i class="fas fa-times"></i> Limpiar Filtros
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Tabla de usuarios -->
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>RUT</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Fecha Creación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if usuarios %}
                                    {% for usuario in usuarios %}
                                        <tr>
                                            <td>{{ usuario.rut }}</td>
                                            <td>{{ usuario.nombre }}</td>
                                            <td>{{ usuario.email }}</td>
                                            <td>
                                                <span class="badge bg-info">{{ roles[usuario.rol] }}</span>
                                            </td>
                                            <td>
                                                {% if usuario.estado %}
                                                    <span class="badge bg-success">Activo</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Inactivo</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ usuario.fecha_creacion|date('d/m/Y H:i') }}</td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{{ app_url }}usuarios/{{ usuario.id }}" 
                                                       class="btn btn-sm btn-info" title="Ver">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="{{ app_url }}usuarios/{{ usuario.id }}/edit" 
                                                       class="btn btn-sm btn-warning" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% if usuario.id != user.id %}
                                                        <button type="button" 
                                                                class="btn btn-sm {{ usuario.estado ? 'btn-danger' : 'btn-success' }}"
                                                                onclick="cambiarEstado({{ usuario.id }}, {{ usuario.estado ? 0 : 1 }})"
                                                                title="{{ usuario.estado ? 'Desactivar' : 'Activar' }}">
                                                            <i class="fas fa-{{ usuario.estado ? 'times' : 'check' }}"></i>
                                                        </button>
                                                        <button type="button" 
                                                                class="btn btn-sm btn-danger"
                                                                onclick="eliminarUsuario({{ usuario.id }})"
                                                                title="Eliminar">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center">No se encontraron usuarios</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    {% if pagination.total_pages > 1 %}
                        <nav aria-label="Paginación de usuarios">
                            <ul class="pagination justify-content-center">
                                {% if pagination.current_page > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ pagination.current_page - 1 }}&search={{ filters.search }}&rol={{ filters.rol }}&estado={{ filters.estado }}">
                                            Anterior
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for page in 1..pagination.total_pages %}
                                    <li class="page-item {{ page == pagination.current_page ? 'active' : '' }}">
                                        <a class="page-link" href="?page={{ page }}&search={{ filters.search }}&rol={{ filters.rol }}&estado={{ filters.estado }}">
                                            {{ page }}
                                        </a>
                                    </li>
                                {% endfor %}
                                
                                {% if pagination.current_page < pagination.total_pages %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ pagination.current_page + 1 }}&search={{ filters.search }}&rol={{ filters.rol }}&estado={{ filters.estado }}">
                                            Siguiente
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function cambiarEstado(userId, nuevoEstado) {
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    Swal.fire({
        title: '¿Estás seguro?',
        text: `¿Deseas ${accion} este usuario?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, continuar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`{{ app_url }}usuarios/${userId}/change-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    estado: nuevoEstado
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire(
                        '¡Éxito!',
                        data.message,
                        'success'
                    ).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire(
                        'Error',
                        data.message,
                        'error'
                    );
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire(
                    'Error',
                    'Ocurrió un error al procesar la solicitud',
                    'error'
                );
            });
        }
    });
}

function eliminarUsuario(userId) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: "Esta acción no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`{{ app_url }}usuarios/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire(
                        '¡Eliminado!',
                        data.message,
                        'success'
                    ).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire(
                        'Error',
                        data.message,
                        'error'
                    );
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire(
                    'Error',
                    'Ocurrió un error al procesar la solicitud',
                    'error'
                );
            });
        }
    });
}
</script>
{% endblock %} 