{% extends "base.twig" %}

{% block title %}Editar Unidad - Sistema de Bibliografía{% endblock %}

{% block current_page %}unidades{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">Editar Unidad</h3>
                        <div>
                            <a href="{{ app_url }}unidades/{{ unidad.id }}" class="btn btn-info">
                                <i class="fas fa-eye"></i> Ver Detalles
                            </a>
                            <a href="{{ app_url }}unidades" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Volver al Listado
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ app_url }}unidades/{{ unidad.id }}/update" id="editUnidadForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="codigo" class="form-label">Código <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="codigo" name="codigo" required 
                                           value="{{ old.codigo|default(unidad.codigo) }}" placeholder="Ej: FAC001">
                                    <small class="form-text text-muted">Código único de la unidad</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required 
                                           value="{{ old.nombre|default(unidad.nombre) }}" placeholder="Ej: Facultad de Ingeniería">
                                    <small class="form-text text-muted">Nombre completo de la unidad</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="sede_id" class="form-label">Sede <span class="text-danger">*</span></label>
                                    <select class="form-control" id="sede_id" name="sede_id" required>
                                        <option value="">Seleccione una sede</option>
                                        {% for sede in sedes %}
                                            <option value="{{ sede.id }}" 
                                                {{ (old.sede_id|default(unidad.sede_id)) == sede.id ? 'selected' : '' }}>
                                                {{ sede.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Sede a la que pertenece la unidad</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_unidad_padre" class="form-label">Unidad Padre</label>
                                    <select class="form-control" id="id_unidad_padre" name="id_unidad_padre">
                                        <option value="">Sin unidad padre</option>
                                        {% for unidad_padre in unidades_padre %}
                                            <option value="{{ unidad_padre.codigo }}" 
                                                {{ (old.id_unidad_padre|default(unidad.id_unidad_padre)) == unidad_padre.codigo ? 'selected' : '' }}>
                                                {{ unidad_padre.codigo }} - {{ unidad_padre.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Unidad padre (opcional)</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-control" id="estado" name="estado">
                                        <option value="1" {{ (old.estado|default(unidad.estado)) == '1' ? 'selected' : '' }}>Activo</option>
                                        <option value="0" {{ (old.estado|default(unidad.estado)) == '0' ? 'selected' : '' }}>Inactivo</option>
                                    </select>
                                    <small class="form-text text-muted">Estado de la unidad</small>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-end">
                                    <a href="{{ app_url }}unidades/{{ unidad.id }}" class="btn btn-secondary mr-2">
                                        <i class="fas fa-times"></i> Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Actualizar Unidad
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function() {
        // Validación del formulario
        $('#editUnidadForm').on('submit', function(e) {
            const codigo = $('#codigo').val().trim();
            const nombre = $('#nombre').val().trim();
            const sede_id = $('#sede_id').val();

            if (!codigo) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El código es obligatorio',
                    confirmButtonColor: '#4e73df'
                });
                $('#codigo').focus();
                return false;
            }

            if (!nombre) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre es obligatorio',
                    confirmButtonColor: '#4e73df'
                });
                $('#nombre').focus();
                return false;
            }

            if (!sede_id) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Debe seleccionar una sede',
                    confirmButtonColor: '#4e73df'
                });
                $('#sede_id').focus();
                return false;
            }

            // Validar que no se seleccione a sí misma como padre
            const unidadPadre = $('#id_unidad_padre').val();
            const codigoActual = '{{ unidad.codigo }}';
            if (unidadPadre === codigoActual) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Una unidad no puede ser padre de sí misma',
                    confirmButtonColor: '#4e73df'
                });
                $('#id_unidad_padre').focus();
                return false;
            }
        });

        // Cargar unidades padre cuando se selecciona una sede
        $('#sede_id').on('change', function() {
            const sedeId = $(this).val();
            const codigoActual = '{{ unidad.codigo }}';
            if (sedeId) {
                $.get('{{ app_url }}api/unidades/padre/' + sedeId, function(data) {
                    if (data.success) {
                        let options = '<option value="">Sin unidad padre</option>';
                        data.data.forEach(function(unidad) {
                            // No mostrar la unidad actual como opción de padre
                            if (unidad.codigo !== codigoActual) {
                                options += `<option value="${unidad.codigo}">${unidad.codigo} - ${unidad.nombre}</option>`;
                            }
                        });
                        $('#id_unidad_padre').html(options);
                        
                        // Restaurar el valor seleccionado si existe
                        const valorAnterior = '{{ old.id_unidad_padre|default(unidad.id_unidad_padre) }}';
                        if (valorAnterior && valorAnterior !== codigoActual) {
                            $('#id_unidad_padre').val(valorAnterior);
                        }
                    }
                });
            } else {
                $('#id_unidad_padre').html('<option value="">Sin unidad padre</option>');
            }
        });

        // Mostrar alertas de SweetAlert2 si existen en la sesión
        {% if session.swal %}
            Swal.fire({
                icon: '{{ session.swal.icon }}',
                title: '{{ session.swal.title|raw }}',
                text: '{{ session.swal.text|raw }}',
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#4e73df',
                timer: null,
                timerProgressBar: false,
                allowOutsideClick: false
            });

            // Limpiar la alerta de la sesión después de mostrarla
            fetch('{{ app_url }}clear-session-messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
        {% endif %}
    });
</script>
{% endblock %} 